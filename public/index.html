<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM - Company Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #fbf9ff;
      --surface: #ffffff;
      --surface-soft: #f5f0ff;
      --border: #e8defa;
      --text: #22163a;
      --text-muted: #756a90;
      --primary: #7c3aed;
      --primary-strong: #5b21b6;
      --primary-soft: #ede9fe;
      --ring: rgba(124, 58, 237, 0.24);
      --shadow: 0 14px 34px rgba(80, 38, 157, 0.1);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--text);
    }

    /* Scrollbar (white themed) */
    html {
      scrollbar-color: #e5e7eb #ffffff;
      scrollbar-width: thin;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #ffffff;
    }

    ::-webkit-scrollbar-thumb {
      background: #e5e7eb;
      border-radius: 8px;
      border: 2px solid #ffffff;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #d1d5db;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 75px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(8px);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      z-index: 1000;
    }

    .sidebar-logo {
      width: 45px;
      height: 45px;
      background: var(--primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
      cursor: pointer;
    }

    .sidebar-logo svg {
      width: 24px;
      height: 24px;
      fill: #ffffff;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      padding: 0 15px;
    }

    .nav-icon {
      width: 45px;
      height: 45px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-decoration: none;
      color: inherit;
    }

    .nav-icon svg {
      width: 22px;
      height: 22px;
      fill: #9ca3af;
      transition: fill 0.3s ease;
    }

    .nav-icon:hover svg,
    .nav-icon.active svg {
      fill: #374151;
    }

    /* Main Content */
    .main-content {
      margin-left: 75px;
      min-height: 100vh;
      background: transparent;
    }

    /* Simple View */
    .simple-view {
      padding: 24px 40px 32px;
    }

    .simple-view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .simple-view-title {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0;
    }

    .user-count-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.86rem;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(80, 38, 157, 0.08);
    }

    .user-count-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
    }

    .user-count-number {
      color: var(--text);
      font-weight: 700;
      min-width: 2ch;
      text-align: right;
    }

    .simple-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
      box-shadow: var(--shadow);
    }

    .simple-item {
      border-bottom: 1px solid #e5e7eb;
    }

    .simple-item:last-child {
      border-bottom: none;
    }

    .simple-row {
      background: var(--surface);
      border: none;
      border-radius: 0;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .simple-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .simple-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a477ff 0%, var(--primary) 60%, var(--primary-strong) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .simple-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .simple-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .simple-uid {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.2px;
    }

    .simple-item {
      transition: background-color 0.25s ease;
    }

    .simple-item:hover {
      background: #fbf8ff;
    }

    .ellipsis-btn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .ellipsis-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .ellipsis-btn span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #6b7280;
      box-shadow: -8px 0 0 #6b7280, 8px 0 0 #6b7280;
      display: block;
    }

    .detailed-view {
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      overflow: hidden;
      transition: max-height 0.45s ease, opacity 0.35s ease, transform 0.35s ease;
      margin: 12px 0 20px;
    }

    .detailed-view.active {
      max-height: 3000px;
      opacity: 1;
      transform: translateY(0);
    }

    /* Top Navigation */
    .top-nav {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-search {
      flex: 1;
      max-width: 520px;
      position: relative;
    }

    .top-search input {
      width: 100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0 14px;
      font-size: 0.9rem;
      color: #111827;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .top-search input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
      background: #ffffff;
    }

    .top-nav-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .signout-btn {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .signout-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .nav-arrows {
      display: flex;
      gap: 10px;
    }

    .nav-arrow {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nav-arrow svg {
      width: 16px;
      height: 16px;
      fill: #6b7280;
    }

    .nav-arrow:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
    }

    .breadcrumb-item {
      color: #9ca3af;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item:hover {
      color: #374151;
    }

    .breadcrumb-item.active {
      color: #111827;
      font-weight: 500;
    }

    .breadcrumb-separator {
      color: #d1d5db;
    }

    /* Content Area */
    .content-area {
      padding: 40px;
      display: flex;
      gap: 30px;
    }

    /* Company Header */
    .company-header {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .company-info {
      display: flex;
      align-items: center;
      gap: 25px;
      margin-bottom: 30px;
    }

    .company-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #a477ff 0%, var(--primary) 60%, var(--primary-strong) 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 14px 26px rgba(89, 35, 170, 0.22);
    }

    .company-avatar svg {
      width: 40px;
      height: 40px;
      fill: #ffffff;
    }

    .company-title h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
    }

    .info-icon {
      width: 20px;
      height: 20px;
      fill: #9ca3af;
      cursor: pointer;
    }

    .company-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 18px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #374151;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      fill: #6b7280;
    }

    .action-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* Left Column */
    .left-column {
      flex: 0 0 400px;
    }

    /* Right Column */
    .right-column {
      flex: 1;
    }

    /* Detail Card */
    .detail-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.28s ease, box-shadow 0.28s ease;
    }

    .detail-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(70, 31, 140, 0.14);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #111827;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      fill: #6b7280;
    }

    .card-action {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-action svg {
      width: 16px;
      height: 16px;
      fill: #9ca3af;
    }

    .card-action:hover {
      background: #f9fafb;
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      padding: 15px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      flex: 0 0 140px;
      color: #9ca3af;
      font-size: 0.9rem;
      font-weight: 400;
    }

    .detail-value {
      color: #111827;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flags {
      display: flex;
      gap: 8px;
    }

    .flag {
      font-size: 1.3rem;
    }

    /* Tabs */
    .tabs-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .tabs-header {
      display: flex;
      align-items: center;
      padding: 0 25px;
      border-bottom: 1px solid #e5e7eb;
      gap: 5px;
    }

    .tab {
      padding: 18px 20px;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      appearance: none;
    }

    .tab svg {
      width: 18px;
      height: 18px;
      fill: #9ca3af;
    }

    .tab:hover {
      color: #374151;
    }

    .tab.active {
      color: #111827;
      border-bottom-color: transparent;
    }

    .tab.active svg {
      fill: #9ca3af;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 25px;
      border-bottom: 1px solid #f3f4f6;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      color: #6b7280;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .filter-tab.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .filter-tab:hover:not(.active) {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .filter-count {
      margin-left: 5px;
      opacity: 0.8;
    }

    /* Timeline */
    .timeline {
      padding: 25px;
    }

    .timeline-header {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 30px;
    }

    .timeline-item {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 19px;
      top: 50px;
      width: 2px;
      height: calc(100% - 30px);
      background: #e5e7eb;
    }

    .timeline-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .timeline-icon svg {
      width: 20px;
      height: 20px;
      fill: #6b7280;
    }

    .timeline-icon.blue {
      background: var(--primary-soft);
    }

    .timeline-icon.blue svg {
      fill: var(--primary);
    }

    .timeline-content {
      flex: 1;
      padding-top: 5px;
    }

    .timeline-title {
      font-size: 0.95rem;
      color: #111827;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .timeline-title a {
      color: var(--primary);
      text-decoration: none;
    }

    .timeline-title a:hover {
      text-decoration: underline;
    }

    .timeline-meta {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #9ca3af;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .timeline-meta svg {
      width: 14px;
      height: 14px;
      fill: #9ca3af;
    }

    .timeline-details {
      margin-top: 10px;
      padding: 12px;
      background: var(--surface-soft);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .timeline-details-toggle {
      color: #6b7280;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .timeline-details-content {
      color: #6b7280;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .timeline-time {
      position: absolute;
      right: 0;
      top: 5px;
      color: #9ca3af;
      font-size: 0.85rem;
    }

    /* Holdings Cards */
    .holdings-view {
      display: none;
      padding: 25px;
    }

    .holdings-view.active {
      display: block;
    }

    .holdings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .holdings-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    .holdings-header span {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .holdings-section {
      margin-bottom: 18px;
    }

    .holdings-section-toggle {
      width: 100%;
      border: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 4px 2px;
      text-align: left;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }

    .holdings-section-toggle:hover {
      background: #f7f2ff;
    }

    .holdings-section-title {
      font-size: 0.82rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      margin: 0;
    }

    .holdings-section-chevron {
      color: var(--text-muted);
      font-size: 0.9rem;
      transition: transform 0.24s ease;
    }

    .holdings-section-content {
      max-height: 3000px;
      opacity: 1;
      overflow: hidden;
      transition: max-height 0.35s ease, opacity 0.25s ease, margin-top 0.25s ease;
      margin-top: 8px;
    }

    .holdings-section.collapsed .holdings-section-content {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }

    .holdings-section.collapsed .holdings-section-chevron {
      transform: rotate(-90deg);
    }

    .holding-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 14px;
      background: #ffffff;
      transition: box-shadow 0.2s ease;
    }

    .holding-card:hover {
      box-shadow: 0 6px 16px rgba(17, 24, 39, 0.08);
    }

    .holding-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .holding-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .holding-price {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      text-align: right;
    }

    .holding-change {
      font-size: 0.8rem;
      font-weight: 600;
      text-align: right;
      color: #10b981;
      margin-top: 2px;
    }

    .holding-desc {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .holding-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .holding-tag {
      background: #f3f4f6;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: #4b5563;
      font-weight: 600;
    }

    .holding-icons {
      display: flex;
      align-items: center;
    }

    .holding-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.7rem;
      color: #ffffff;
      margin-left: -8px;
    }

    .holding-icon:first-child {
      margin-left: 0;
    }

    .icon-orange { background: #ea580c; }
    .icon-gold { background: #d97706; }
    .icon-brown { background: #92400e; }
    .icon-green { background: #059669; }
    .icon-blue { background: #2563eb; }
    .icon-lightblue { background: #0ea5e9; }
    .icon-gray { background: #6b7280; }
    .icon-purple { background: #7c3aed; }
    .icon-red { background: #dc2626; }
    .icon-pink { background: #db2777; }

    .holding-count {
      font-size: 0.8rem;
      color: #6b7280;
      margin-left: 6px;
    }

    .holding-label {
      font-size: 0.8rem;
      color: #9ca3af;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Phone modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-card {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      padding: 24px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: #111827;
    }

    .modal-close {
      border: none;
      background: #f3f4f6;
      color: #6b7280;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .modal-body label {
      font-size: 0.9rem;
      color: #374151;
      font-weight: 500;
    }

    .modal-body input {
      height: 42px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 0 12px;
      font-size: 0.9rem;
      outline: none;
    }

    .modal-body input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .image-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 320px;
      overflow-y: auto;
    }

    .image-list button {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.9rem;
      color: #111827;
    }

    .image-list button:hover {
      background: #f9fafb;
    }

    .image-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: left;
    }

    .image-meta small {
      color: #6b7280;
      font-size: 0.75rem;
    }

    .image-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .image-actions button {
      border: 1px solid #e5e7eb;
      background: #ffffff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #111827;
    }

    .image-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .image-actions button:hover {
      background: #f9fafb;
    }

    .modal-actions small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .modal-btn {
      height: 38px;
      padding: 0 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-btn.primary {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    /* Responsive */
    @media screen and (max-width: 1200px) {
      .content-area {
        flex-direction: column;
      }

      .left-column {
        flex: 1;
        width: 100%;
      }
    }

    @media screen and (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .main-content {
        margin-left: 0;
      }

      .content-area {
        padding: 20px;
      }

      .simple-view {
        padding: 18px 20px 24px;
      }

      .simple-view-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .top-nav {
        padding: 15px 20px;
      }

      .company-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .company-actions {
        width: 100%;
      }

      .action-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <svg viewBox="0 0 24 24">
        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </div>

    <nav class="sidebar-nav">
      <a class="nav-icon" href="/dashboard.html" aria-label="Dashboard">
        <svg viewBox="0 0 24 24">
          <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
      </a>

      <a class="nav-icon" href="/index.html" aria-label="Profiles">
        <svg viewBox="0 0 24 24">
          <path d="M12 12c1.66 0 3-1.34 3-3S13.66 6 12 6 9 7.34 9 9s1.34 3 3 3zm0 2c-2.22 0-6 1.11-6 3.33V19h12v-1.67C18 15.11 14.22 14 12 14z"/>
        </svg>
      </a>

      <a class="nav-icon" href="#" aria-label="Settings">
        <svg viewBox="0 0 24 24">
          <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.62l-1.92-3.32c-.11-.2-.36-.28-.58-.2l-2.39.96c-.5-.38-1.05-.7-1.66-.94l-.36-2.54A.488.488 0 0 0 14.9 2h-3.8c-.24 0-.44.17-.48.4l-.36 2.54c-.61.24-1.16.56-1.66.94l-2.39-.96a.5.5 0 0 0-.58.2L3.7 8.44c-.11.21-.06.48.12.62l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.62l1.92 3.32c.11.2.36.28.58.2l2.39-.96c.5.38 1.05.7 1.66.94l.36 2.54c.04.23.24.4.48.4h3.8c.24 0 .44-.17.48-.4l.36-2.54c.61-.24 1.16-.56 1.66-.94l2.39.96c.22.08.47 0 .58-.2l1.92-3.32a.5.5 0 0 0-.12-.62l-2.03-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5S10.07 8.5 12 8.5s3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
        </svg>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation -->
    <div class="top-nav">
      <div class="top-search">
        <input type="search" placeholder="Search profiles..." aria-label="Search profiles">
      </div>

      <div class="top-nav-actions">
        <button class="signout-btn" id="signOutBtn">Sign out</button>
      </div>
    </div>

    <section class="simple-view" id="simpleView">
      <div class="simple-view-header">
        <h2 class="simple-view-title">Profiles</h2>
        <div class="user-count-badge" aria-live="polite" aria-atomic="true">
          <span class="user-count-dot" aria-hidden="true"></span>
          <span class="user-count-number" id="userCount">0</span>
          <span id="userCountLabel">users</span>
        </div>
      </div>
      <div class="simple-list" id="profilesList"></div>

      <template id="profileItemTemplate">
        <div class="simple-item">
          <div class="simple-row">
            <div class="simple-left">
              <div class="simple-avatar" data-initials>AA</div>
              <div class="simple-text">
                <div class="simple-name" data-name>Alex Adams</div>
                <div class="simple-uid" data-uid>UID: AA-0000-XX</div>
              </div>
            </div>
            <button class="ellipsis-btn show-details-btn" aria-label="Show profile details">
              <span></span>
            </button>
          </div>

          <div class="detailed-view">
            <div class="content-area">
            <div class="left-column">
              <div class="company-header">
                <div class="company-info">
                  <div class="company-avatar" data-company-avatar>
                    <svg viewBox="0 0 24 24">
                      <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                  </div>
                  <div class="company-title">
                    <h1>
                      <span data-name>Alex Adams</span>
                      <svg class="info-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                      </svg>
                    </h1>
                  </div>
                </div>

                <div class="detail-row" style="padding-top: 0; border-bottom: none;">
                  <div class="detail-label">UID</div>
                  <div class="detail-value" data-uid>UID: AA-0000-XX</div>
                </div>
              </div>

              <div class="detail-card">
                <div class="card-header">
                  <div class="card-title">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Company details
                  </div>
                  <button class="card-action">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                  </button>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Contact Address</div>
                  <div class="detail-value" data-address>174 Quai de Jemmapes</div>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Created at</div>
                  <div class="detail-value" data-created>Not added</div>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Website</div>
                  <div class="detail-value" data-website>bb.agency</div>
                </div>
              </div>

              <div class="detail-card">
                <div class="card-header">
                  <div class="card-title">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Contact details
                  </div>
                  <button class="card-action phone-add-btn" aria-label="Add phone number">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                  </button>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Phone number</div>
                  <div class="detail-value" data-phone>Not added</div>
                </div>
              </div>
            </div>

            <div class="right-column">
              <div class="tabs-container">
                <div class="tabs-header">
                  <div class="tab">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    KYC: <span data-kyc-status>Not initiated</span>
                  </div>
                  <div class="tab active" data-pack="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 3c.55 0 1 .45 1 1v8.17l2.59-2.58 1.41 1.41L12 17l-5-5 1.41-1.41L11 12.17V4c0-.55.45-1 1-1zm-7 14h14v2H5v-2z"/>
                    </svg>
                    Pack
                  </div>
                  <button class="tab kyc-images-btn" type="button" data-images="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm1 7V3.5L18.5 9H15z"/>
                    </svg>
                    Documents
                  </button>
                </div>

                <div class="filter-tabs">
                  <button class="filter-tab active" data-view="history">
                    History
                  </button>
                  <button class="filter-tab" data-view="holdings">
                    Current holdings
                  </button>
                </div>

                <div class="timeline history-view">
                  <h2 class="timeline-header">History</h2>

                  <div class="timeline-item">
                    <div class="timeline-icon blue">
                      <svg viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        File has been uploaded <a href="#">my-cool-file.jpg</a>
                        <svg style="width: 16px; height: 16px; fill: #9ca3af; margin-left: 5px;" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Added by: Lora Adams
                      </div>
                      <div class="timeline-time">2 hours ago</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon">
                      <svg viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        Triggered an event <span style="color: #dc2626;">webinar-email-follow-up</span>
                      </div>
                      <div class="timeline-details-toggle">
                        Hide data ˄
                      </div>
                      <div class="timeline-details">
                        <div class="timeline-details-content">
                          <strong>source</strong> Christmas Promotion Website
                        </div>
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Triggered by: John Lock
                      </div>
                      <div class="timeline-time">December 14, 2023 at 3:31 PM</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon blue">
                      <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        Meeting scheduled
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Scheduled by: Sarah Chen
                      </div>
                      <div class="timeline-time">Yesterday</div>
                    </div>
                  </div>
                </div>

                <div class="holdings-view">
                  <div class="holdings-header">
                    <h2>Current holdings</h2>
                    <span>Showing 5 of 5</span>
                  </div>

                  <div class="holdings-section">
                    <button class="holdings-section-toggle" type="button" aria-expanded="true">
                      <span class="holdings-section-title">Strategy</span>
                      <span class="holdings-section-chevron">▾</span>
                    </button>

                    <div class="holdings-section-content">
                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Income Defensive</div>
                          </div>
                          <div>
                            <div class="holding-price">R 104.20</div>
                            <div class="holding-change">+0.00%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Low • A conservative income focused strategy p...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Low</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-orange">C</div>
                              <div class="holding-icon icon-gold">G</div>
                              <div class="holding-icon icon-brown">⬡</div>
                            </div>
                            <span class="holding-count">+7</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Balanced Core</div>
                          </div>
                          <div>
                            <div class="holding-price">R 108.45</div>
                            <div class="holding-change">+0.01%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Balanced • A diversified South African strategy focu...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Balanced</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-green">S</div>
                              <div class="holding-icon icon-blue">E</div>
                              <div class="holding-icon icon-lightblue">G</div>
                            </div>
                            <span class="holding-count">+2</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Blended Focus</div>
                          </div>
                          <div>
                            <div class="holding-price">R 132.80</div>
                            <div class="holding-change">+0.03%</div>
                          </div>
                        </div>
                        <div class="holding-desc">High • A blended, fundamentally driven JSE equi...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">High</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-gray">⬡</div>
                              <div class="holding-icon icon-brown">A</div>
                              <div class="holding-icon icon-purple">OU</div>
                            </div>
                            <span class="holding-count">+6</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="holdings-section">
                    <button class="holdings-section-toggle" type="button" aria-expanded="true">
                      <span class="holdings-section-title">Individual stocks</span>
                      <span class="holdings-section-chevron">▾</span>
                    </button>

                    <div class="holdings-section-content">
                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Famous Brands</div>
                          </div>
                          <div>
                            <div class="holding-price">R 125.60</div>
                            <div class="holding-change">+0.01%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Growth • A high growth equity strategy targeting ...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Growth</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-gray">C</div>
                              <div class="holding-icon icon-blue">K</div>
                              <div class="holding-icon icon-pink">M</div>
                            </div>
                            <span class="holding-count">+6</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">TechNova Systems</div>
                          </div>
                          <div>
                            <div class="holding-price">R 89.35</div>
                            <div class="holding-change">+0.06%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Momentum • Mid-cap technology stock with strong quarterly growth.</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Momentum</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-purple">TN</div>
                              <div class="holding-icon icon-lightblue">AI</div>
                            </div>
                            <span class="holding-count">+1</span>
                            <span class="holding-label">Stock</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </template>
    </section>
  </main>

  <div class="modal-overlay" id="phoneModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Add phone number</div>
        <button class="modal-close" id="phoneModalClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <label for="phoneInput">Phone number</label>
        <input id="phoneInput" type="tel" placeholder="e.g. +27 82 123 4567">
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="phoneModalCancel">Cancel</button>
        <button class="modal-btn primary" id="phoneModalSave">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="imageModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Select document</div>
        <button class="modal-close" id="imageModalClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="image-list" id="imageList"></div>
      </div>
      <div class="modal-actions">
        <small>Tip: View a document first to enable downloads.</small>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://mfxnghmuccevsxwcetej.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1meG5naG11Y2NldnN4d2NldGVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NTI1ODAsImV4cCI6MjA4NDQyODU4MH0.lktfglzBMaHd79hLFDRH1HHSwsEwZ56Tv6e287kQiFg';
    const PROFILES_TABLE = 'profiles';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const profilesList = document.getElementById('profilesList');
    const profileTemplate = document.getElementById('profileItemTemplate');
    const userCount = document.getElementById('userCount');
    const userCountLabel = document.getElementById('userCountLabel');
    const searchInput = document.querySelector('.top-search input');
    let allProfiles = [];
    let allKycMap = {};

    const getInitials = (name = '') => {
      const parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'NA';
      return parts.slice(0, 2).map(part => part[0].toUpperCase()).join('');
    };

    const setText = (root, selector, value) => {
      const resolved = value === undefined || value === null || value === '' ? 'Not added' : value;
      root.querySelectorAll(selector).forEach(el => {
        el.textContent = resolved;
      });
    };

    const phoneModal = document.getElementById('phoneModal');
    const phoneInput = document.getElementById('phoneInput');
    const phoneModalClose = document.getElementById('phoneModalClose');
    const phoneModalCancel = document.getElementById('phoneModalCancel');
    const phoneModalSave = document.getElementById('phoneModalSave');
    let activePhoneItem = null;

    const imageModal = document.getElementById('imageModal');
    const imageList = document.getElementById('imageList');
    const imageModalClose = document.getElementById('imageModalClose');
    let activeInspectionId = null;
    let activeImages = [];

    const openPhoneModal = (item) => {
      activePhoneItem = item;
      if (phoneInput) phoneInput.value = '';
      if (phoneModal) phoneModal.classList.add('active');
    };

    const closePhoneModal = () => {
      activePhoneItem = null;
      if (phoneModal) phoneModal.classList.remove('active');
    };

    const openImageModal = (inspectionId, images) => {
      activeInspectionId = inspectionId;
      activeImages = images;
      if (!imageModal || !imageList) return;
      imageList.innerHTML = '';

      images.forEach((img, index) => {
        const imageId = img?.id || img?.previewId || img?.imageId || img?.resourceId;
        if (!imageId) return;
        const button = document.createElement('button');
        const fileName = img?.fileMetadata?.fileName || `Document ${index + 1}`;
        const fileType = img?.fileMetadata?.fileType || 'Unknown type';
        const addedDate = img?.addedDate || img?.createdAt || '';

        button.type = 'button';
        button.dataset.imageId = imageId;
        button.innerHTML = `
          <span class="image-meta">
            <strong>${fileName}</strong>
            <small>${fileType}${addedDate ? ` • ${addedDate}` : ''}</small>
          </span>
          <span class="image-actions">
            <button type="button" data-action="download" disabled>Download</button>
          </span>
        `;

        const downloadButton = button.querySelector('[data-action="download"]');
        if (downloadButton) {
          downloadButton.addEventListener('click', async (downloadEvent) => {
            downloadEvent.stopPropagation();
            if (!activeInspectionId || !imageId) return;
            try {
              const blob = await fetchApplicantImage(activeInspectionId, imageId);
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              link.remove();
              URL.revokeObjectURL(url);
            } catch (error) {
              console.error('Sumsub download error:', error);
            }
          });
        }

        button.addEventListener('click', () => {
          if (!activeInspectionId || !imageId) return;
          fetchApplicantImage(activeInspectionId, imageId)
            .then((imageBlob) => {
              const imageUrl = URL.createObjectURL(imageBlob);
              window.open(imageUrl, '_blank', 'noopener');
              setTimeout(() => URL.revokeObjectURL(imageUrl), 15000);
              if (downloadButton) downloadButton.disabled = false;
            })
            .catch((error) => {
              console.error('Sumsub image error:', error);
            });
        });

        imageList.appendChild(button);
      });

      imageModal.classList.add('active');
    };

    const closeImageModal = () => {
      activeInspectionId = null;
      activeImages = [];
      if (imageModal) imageModal.classList.remove('active');
      if (imageList) imageList.innerHTML = '';
    };

    const renderProfiles = (profiles = [], kycMap = {}) => {
      if (!profilesList || !profileTemplate) return;
      profilesList.innerHTML = '';
      const totalUsers = profiles.length;
      if (userCount) userCount.textContent = String(totalUsers);
      if (userCountLabel) userCountLabel.textContent = totalUsers === 1 ? 'user' : 'users';

      profiles.forEach(profile => {
        const clone = profileTemplate.content.firstElementChild.cloneNode(true);
        const fullName = [profile.first_name, profile.last_name].filter(Boolean).join(' ') || 'Unknown User';
        const uid = profile.id;

        if (profile.id) {
          clone.dataset.profileId = profile.id;
        }

        setText(clone, '[data-name]', fullName);
        setText(clone, '[data-uid]', `UID: ${uid}`);
        setText(clone, '[data-company]', fullName);
        setText(clone, '[data-city]', profile.city);
        setText(clone, '[data-country]', profile.country);
        setText(clone, '[data-address]', profile.address);
        setText(clone, '[data-created]', profile.created_at);
        setText(clone, '[data-website]', profile.email);
        setText(clone, '[data-phone]', profile.phone_number);
        const kycEntry = kycMap[profile.id] || {};
        setText(clone, '[data-kyc-status]', kycEntry.status || 'Not initiated');

        const initialsEl = clone.querySelector('[data-initials]');
        if (initialsEl) {
          if (profile.avatar_url) {
            initialsEl.textContent = '';
            initialsEl.style.backgroundImage = `url('${profile.avatar_url}')`;
            initialsEl.style.backgroundSize = 'cover';
            initialsEl.style.backgroundPosition = 'center';
            initialsEl.style.color = 'transparent';
          } else {
            initialsEl.textContent = getInitials(fullName);
          }
        }

        const companyAvatar = clone.querySelector('[data-company-avatar]');
        if (companyAvatar && profile.avatar_url) {
          companyAvatar.innerHTML = '';
          companyAvatar.style.backgroundImage = `url('${profile.avatar_url}')`;
          companyAvatar.style.backgroundSize = 'cover';
          companyAvatar.style.backgroundPosition = 'center';
        }

        if (kycEntry.externalUserId) {
          clone.dataset.externalUserId = kycEntry.externalUserId;
        }

        profilesList.appendChild(clone);
      });
    };

    const applySearchFilter = () => {
      const query = searchInput?.value?.trim().toLowerCase() || '';
      if (!query) {
        renderProfiles(allProfiles, allKycMap);
        return;
      }

      const filtered = allProfiles.filter(profile => {
        const fullName = [profile.first_name, profile.last_name].filter(Boolean).join(' ');
        const uid = profile.id || '';
        return fullName.toLowerCase().includes(query) || String(uid).toLowerCase().includes(query);
      });

      renderProfiles(filtered, allKycMap);
    };

    const loadProfiles = async () => {
      const { data, error } = await supabaseClient
        .from(PROFILES_TABLE)
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Supabase load error:', error);
        return;
      }

      const profiles = data || [];
      const userIds = profiles.map(profile => profile.id).filter(Boolean);
      let kycMap = {};

      if (userIds.length) {
        const { data: onboarding, error: onboardingError } = await supabaseClient
          .from('user_onboarding')
          .select('user_id, kyc_status, sumsub_external_user_id')
          .in('user_id', userIds);

        if (!onboardingError && onboarding) {
          kycMap = onboarding.reduce((acc, row) => {
            acc[row.user_id] = {
              status: row.kyc_status || 'Not initiated',
              externalUserId: row.sumsub_external_user_id || ''
            };
            return acc;
          }, {});
        }
      }

      allProfiles = profiles;
      allKycMap = kycMap;
      renderProfiles(allProfiles, allKycMap);
      applySearchFilter();
    };

    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        window.location.href = '/signin.html';
        return false;
      }
      return true;
    };

    const downloadJson = (data, filename) => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const fetchApplicantByExternalId = async (externalUserId) => {
      const res = await fetch(`/api/sumsub/applicant?externalUserId=${encodeURIComponent(externalUserId)}`);
      if (!res.ok) {
        throw new Error(`Applicant fetch failed: ${res.status}`);
      }
      return res.json();
    };

    const fetchApplicantMetadata = async (applicantId) => {
      const res = await fetch(`/api/sumsub/metadata?applicantId=${encodeURIComponent(applicantId)}`);
      if (!res.ok) {
        throw new Error(`Metadata fetch failed: ${res.status}`);
      }
      return res.json();
    };

    const fetchApplicantImage = async (inspectionId, imageId) => {
      const res = await fetch(`/api/sumsub/image?inspectionId=${encodeURIComponent(inspectionId)}&imageId=${encodeURIComponent(imageId)}`);
      if (!res.ok) {
        throw new Error(`Image fetch failed: ${res.status}`);
      }
      return res.blob();
    };

    const findFirstValueByKeys = (value, keys) => {
      if (!value || typeof value !== 'object') return null;
      if (Array.isArray(value)) {
        for (const item of value) {
          const found = findFirstValueByKeys(item, keys);
          if (found) return found;
        }
        return null;
      }
      for (const key of keys) {
        if (value[key]) return value[key];
      }
      for (const child of Object.values(value)) {
        const found = findFirstValueByKeys(child, keys);
        if (found) return found;
      }
      return null;
    };


    document.addEventListener('click', (event) => {
      const tab = event.target.closest('.tab');
      if (tab) {
        const header = tab.closest('.tabs-header');
        if (!header) return;
        header.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (tab.dataset.pack === 'true') {
          const item = tab.closest('.simple-item');
          const externalUserId = item?.dataset?.externalUserId;
          if (!externalUserId) {
            console.warn('No Sumsub external user id found for this profile.');
            return;
          }
          fetch(`/api/sumsub/applicant?externalUserId=${encodeURIComponent(externalUserId)}`)
            .then(res => res.json())
            .then(json => {
              console.log('Sumsub applicant:', json);
              downloadJson(json, `sumsub-${externalUserId}.json`);
            })
            .catch(err => console.error('Sumsub error:', err));
        }

        if (tab.dataset.images === 'true') {
          const item = tab.closest('.simple-item');
          const externalUserId = item?.dataset?.externalUserId;
          if (!externalUserId) {
            console.warn('No Sumsub external user id found for this profile.');
            return;
          }

          (async () => {
            try {
              const applicant = await fetchApplicantByExternalId(externalUserId);
              const applicantId = applicant?.id || applicant?.applicantId || applicant?.applicant_id;
              if (!applicantId) {
                console.warn('No applicantId found in Sumsub response.');
                return;
              }

              const metadata = await fetchApplicantMetadata(applicantId);
              const inspectionId = applicant?.inspectionId || applicant?.review?.inspectionId || findFirstValueByKeys(applicant, ['inspectionId']);
              const items = Array.isArray(metadata)
                ? metadata
                : (metadata?.resources || metadata?.items || metadata?.images || metadata?.data?.resources || [metadata]);

              if (!inspectionId || !items.length) {
                console.warn('Missing inspectionId or image list from responses.', { inspectionId, metadata });
                return;
              }

              openImageModal(inspectionId, items);
            } catch (error) {
              console.error('Sumsub image error:', error);
            }
          })();
        }
      }

      const filterTab = event.target.closest('.filter-tab');
      if (filterTab) {
        const filterGroup = filterTab.closest('.filter-tabs');
        if (!filterGroup) return;
        filterGroup.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        filterTab.classList.add('active');

        const container = filterTab.closest('.tabs-container');
        if (!container) return;
        const historyView = container.querySelector('.history-view');
        const holdingsView = container.querySelector('.holdings-view');
        const view = filterTab.getAttribute('data-view');
        if (historyView) {
          historyView.style.display = view === 'holdings' ? 'none' : 'block';
        }
        if (holdingsView) {
          holdingsView.classList.toggle('active', view === 'holdings');
        }

        if (view === 'holdings') {
          return;
        }
      }

      const sectionToggle = event.target.closest('.holdings-section-toggle');
      if (sectionToggle) {
        const section = sectionToggle.closest('.holdings-section');
        if (!section) return;
        const isCollapsed = section.classList.toggle('collapsed');
        sectionToggle.setAttribute('aria-expanded', String(!isCollapsed));
      }

      const toggle = event.target.closest('.timeline-details-toggle');
      if (toggle) {
        const details = toggle.nextElementSibling;
        if (!details) return;
        if (details.style.display === 'none') {
          details.style.display = 'block';
          toggle.textContent = 'Hide data ˄';
        } else {
          details.style.display = 'none';
          toggle.textContent = 'Show data ˅';
        }
      }

      const button = event.target.closest('.show-details-btn');
      if (button) {
        const item = button.closest('.simple-item');
        if (!item) return;
        const details = item.querySelector('.detailed-view');
        if (!details) return;
        details.classList.toggle('active');
      }

      const phoneAdd = event.target.closest('.phone-add-btn');
      if (phoneAdd) {
        const item = phoneAdd.closest('.simple-item');
        if (!item) return;
        openPhoneModal(item);
      }
    });

    if (phoneModalClose) phoneModalClose.addEventListener('click', closePhoneModal);
    if (phoneModalCancel) phoneModalCancel.addEventListener('click', closePhoneModal);
    if (phoneModal) {
      phoneModal.addEventListener('click', (event) => {
        if (event.target === phoneModal) closePhoneModal();
      });
    }

    if (imageModalClose) imageModalClose.addEventListener('click', closeImageModal);
    if (imageModal) {
      imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) closeImageModal();
      });
    }

    if (phoneModalSave) {
      phoneModalSave.addEventListener('click', async () => {
        const item = activePhoneItem;
        const profileId = item?.dataset?.profileId;
        const newNumber = phoneInput?.value?.trim();
        if (!item || !profileId || !newNumber) return;

        const { error } = await supabaseClient
          .from('profiles')
          .update({ phone_number: newNumber })
          .eq('id', profileId);

        if (error) {
          console.error('Phone update failed:', error);
          return;
        }

        const phoneEl = item.querySelector('[data-phone]');
        if (phoneEl) phoneEl.textContent = newNumber;
        closePhoneModal();
      });
    }

    const signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = '/signin.html';
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', applySearchFilter);
    }

    requireSession().then((ok) => {
      if (ok) {
        loadProfiles();
      }
    });
  </script>
</body>
</html>
