<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM - Company Profile</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #fbf9ff;
      --surface: #ffffff;
      --surface-soft: #f5f0ff;
      --border: #e8defa;
      --text: #22163a;
      --text-muted: #756a90;
      --primary: #7c3aed;
      --primary-strong: #5b21b6;
      --primary-soft: #ede9fe;
      --ring: rgba(124, 58, 237, 0.24);
      --shadow: 0 14px 34px rgba(80, 38, 157, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--text);
    }

    /* Scrollbar (white themed) */
    html {
      scrollbar-color: #e5e7eb #ffffff;
      scrollbar-width: thin;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #ffffff;
    }

    ::-webkit-scrollbar-thumb {
      background: #e5e7eb;
      border-radius: 8px;
      border: 2px solid #ffffff;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #d1d5db;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 75px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(8px);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      z-index: 1000;
    }

    .sidebar-logo {
      width: 45px;
      height: 45px;
      background: transparent;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
      cursor: pointer;
    }

    .sidebar-logo svg {
      width: 24px;
      height: 24px;
      fill: #ffffff;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      padding: 0 15px;
    }

    .nav-icon {
      width: 45px;
      height: 45px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-decoration: none;
      color: inherit;
    }

    .nav-icon svg {
      width: 22px;
      height: 22px;
      fill: #9ca3af;
      transition: fill 0.3s ease;
    }

    .nav-icon:hover svg,
    .nav-icon.active svg {
      fill: #374151;
    }

    /* Main Content */
    .main-content {
      margin-left: 75px;
      min-height: 100vh;
      background: transparent;
    }

    /* Simple View */
    .simple-view {
      padding: 24px 40px 32px;
    }

    .simple-view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .simple-view-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0;
    }

    .user-count-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .user-count-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      order: 2;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.86rem;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(80, 38, 157, 0.08);
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
    }

    .user-count-badge:hover,
    .user-count-badge[aria-expanded="true"] {
      border-color: var(--primary);
      box-shadow: 0 8px 18px rgba(80, 38, 157, 0.16);
      color: var(--text);
    }

    .quick-filter-row {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      order: 1;
    }

    .quick-filter-pill {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #ffffff;
      color: #6b7280;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-filter-pill:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.12);
    }

    .quick-filter-pill.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .bank-filter-wrap {
      position: relative;
    }

    .bank-filter-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      min-width: 156px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 14px 30px rgba(80, 38, 157, 0.16);
      padding: 6px;
      display: none;
      z-index: 60;
    }

    .bank-filter-menu.active {
      display: block;
    }

    .bank-filter-option {
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      color: #4b5563;
      font-size: 0.8rem;
      font-weight: 500;
      border-radius: 8px;
      padding: 7px 9px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .bank-filter-option:hover {
      background: #f5f3ff;
      color: #5b21b6;
    }

    .bank-filter-option.active {
      background: #ede9fe;
      color: #4c1d95;
      font-weight: 600;
    }

    .user-count-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
    }

    .user-count-number {
      color: var(--text);
      font-weight: 700;
      min-width: 2ch;
      text-align: right;
    }

    .simple-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
      box-shadow: var(--shadow);
    }

    .simple-item {
      border-bottom: 1px solid #e5e7eb;
    }

    .simple-item:last-child {
      border-bottom: none;
    }

    .simple-row {
      background: var(--surface);
      border: none;
      border-radius: 0;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .simple-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .simple-right {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
    }

    .sumsub-review-pulse {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: #d1d5db;
      box-shadow: 0 0 0 0 rgba(209, 213, 219, 0.7);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .sumsub-review-pulse.active {
      opacity: 1;
      animation: sumsubPulse 1.6s ease-out infinite;
    }

    .sumsub-review-pulse.green {
      background: #16a34a;
      box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.52);
    }

    .sumsub-review-pulse.yellow {
      background: #f59e0b;
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.52);
    }

    .sumsub-review-pulse.red {
      background: #dc2626;
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.52);
    }

    @keyframes sumsubPulse {
      0% {
        transform: scale(0.96);
        opacity: 0.85;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(0.96);
        opacity: 0.85;
      }
    }

    .simple-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a477ff 0%, var(--primary) 60%, var(--primary-strong) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .simple-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .simple-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .simple-uid {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.2px;
    }

    .simple-item {
      transition: background-color 0.25s ease;
    }

    .simple-item:hover {
      background: #fbf8ff;
    }

    .ellipsis-btn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .ellipsis-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .ellipsis-btn svg {
      width: 16px;
      height: 16px;
      fill: #6b7280;
      transition: transform 0.2s ease, fill 0.2s ease, opacity 0.2s ease;
    }

    .ellipsis-btn.is-open svg {
      transform: rotate(180deg);
    }

    .ellipsis-btn.is-loading {
      opacity: 0.65;
      cursor: progress;
    }

    .ellipsis-btn.is-loading svg {
      fill: var(--primary);
      animation: chevronPulse 1s ease-in-out infinite;
    }

    @keyframes chevronPulse {
      0%,
      100% {
        opacity: 0.5;
      }
      50% {
        opacity: 1;
      }
    }

    .detailed-view {
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      overflow: hidden;
      transition: max-height 0.45s ease, opacity 0.35s ease, transform 0.35s ease;
      margin: 12px 0 20px;
    }

    .detailed-view.active {
      max-height: 3000px;
      opacity: 1;
      transform: translateY(0);
    }

    /* Top Navigation */
    .top-nav {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-search {
      flex: 1;
      max-width: 520px;
      position: relative;
    }

    .top-search input {
      width: 100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0 14px;
      font-size: 0.9rem;
      color: #111827;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .top-search input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
      background: #ffffff;
    }

    .top-nav-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .signout-btn {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .signout-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .nav-arrows {
      display: flex;
      gap: 10px;
    }

    .nav-arrow {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nav-arrow svg {
      width: 16px;
      height: 16px;
      fill: #6b7280;
    }

    .nav-arrow:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
    }

    .breadcrumb-item {
      color: #9ca3af;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item:hover {
      color: #374151;
    }

    .breadcrumb-item.active {
      color: #111827;
      font-weight: 500;
    }

    .breadcrumb-separator {
      color: #d1d5db;
    }

    /* Content Area */
    .content-area {
      padding: 40px;
      display: flex;
      gap: 30px;
    }

    /* Company Header */
    .company-header {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .company-info {
      display: flex;
      align-items: center;
      gap: 25px;
      margin-bottom: 30px;
    }

    .company-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #a477ff 0%, var(--primary) 60%, var(--primary-strong) 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 14px 26px rgba(89, 35, 170, 0.22);
    }

    .company-avatar svg {
      width: 40px;
      height: 40px;
      fill: #ffffff;
    }

    .company-title h1 {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0;
    }

    .info-icon {
      width: 20px;
      height: 20px;
      fill: #9ca3af;
      cursor: pointer;
    }

    .company-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 18px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      color: #374151;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      fill: #6b7280;
    }

    .action-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* Left Column */
    .left-column {
      flex: 0 0 400px;
    }

    /* Right Column */
    .right-column {
      flex: 1;
    }

    /* Detail Card */
    .detail-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.28s ease, box-shadow 0.28s ease;
    }

    .detail-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(70, 31, 140, 0.14);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #111827;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      fill: #6b7280;
    }

    .card-action {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-action svg {
      width: 16px;
      height: 16px;
      fill: #9ca3af;
    }

    .card-action:hover {
      background: #f9fafb;
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      padding: 15px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      flex: 0 0 140px;
      color: #9ca3af;
      font-size: 0.9rem;
      font-weight: 400;
    }

    .detail-value {
      color: #111827;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flags {
      display: flex;
      gap: 8px;
    }

    .flag {
      font-size: 1.3rem;
    }

    /* Tabs */
    .tabs-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .tabs-header {
      display: flex;
      align-items: center;
      padding: 0 25px;
      border-bottom: 1px solid #e5e7eb;
      gap: 5px;
    }

    .tab {
      padding: 18px 20px;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      appearance: none;
    }

    .tab svg {
      width: 18px;
      height: 18px;
      fill: #9ca3af;
    }

    .tab:hover {
      color: var(--primary);
      text-shadow: 0 0 10px rgba(124, 58, 237, 0.28);
    }

    .tab:hover svg {
      fill: var(--primary);
      filter: drop-shadow(0 0 6px rgba(124, 58, 237, 0.3));
    }

    .tab.active {
      color: #111827;
      border-bottom-color: transparent;
    }

    .tab.active svg {
      fill: #9ca3af;
    }

    .tab.is-loading {
      opacity: 0.75;
      cursor: progress;
      pointer-events: none;
    }

    .tab.is-loading::after {
      content: 'Downloading...';
      font-size: 0.72rem;
      color: #6b7280;
      margin-left: 6px;
      font-weight: 600;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 25px;
      border-bottom: 1px solid #f3f4f6;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      color: #6b7280;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .filter-tab.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .filter-tab:hover:not(.active) {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.14), 0 6px 14px rgba(124, 58, 237, 0.1);
    }

    .pack-details-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      color: #6b7280;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .pack-details-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
      color: #9ca3af;
    }

    .pack-details-btn:not(:disabled):hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.14), 0 6px 14px rgba(124, 58, 237, 0.1);
    }

    .pack-details-btn.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .pack-details-view {
      display: none;
      padding: 25px;
    }

    .pack-details-view.active {
      display: block;
    }

    .pack-details-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      background: #ffffff;
      margin-bottom: 16px;
    }

    .pack-details-card.purple {
      border-color: #ddd6fe;
      background: linear-gradient(180deg, #faf5ff 0%, #ffffff 100%);
      box-shadow: 0 10px 24px rgba(91, 33, 182, 0.08);
    }

    .pack-details-title {
      font-size: 1rem;
      font-weight: 600;
      color: #2e1065;
      margin-bottom: 12px;
    }

    .pack-hero {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, #ede9fe 0%, #f5f3ff 100%);
      border: 1px solid #ddd6fe;
    }

    .pack-hero-title {
      font-size: 1.02rem;
      color: #2e1065;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .pack-hero-subtitle {
      font-size: 0.82rem;
      color: #3b1a75;
    }

    .pack-download-btn {
      border: 1px solid #c4b5fd;
      background: #ffffff;
      color: #5b21b6;
      font-size: 0.78rem;
      font-weight: 700;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pack-download-btn:hover {
      background: #f5f3ff;
      border-color: #a78bfa;
    }

    .pack-badge {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.74rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid #c4b5fd;
      color: #5b21b6;
      background: #f5f3ff;
      white-space: nowrap;
    }

    .pack-kv-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 16px;
    }

    .pack-kv-item {
      border: 1px solid #ede9fe;
      border-radius: 12px;
      padding: 10px;
      background: #ffffff;
    }

    .pack-kv-label {
      font-size: 0.72rem;
      font-weight: 700;
      color: #3b1a75;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .pack-kv-value {
      font-size: 0.86rem;
      color: #1f2937;
      font-weight: 600;
      word-break: break-word;
    }

    .pack-list {
      display: grid;
      gap: 10px;
    }

    .pack-list-item {
      border: 1px solid #ede9fe;
      border-radius: 12px;
      padding: 12px;
      background: #ffffff;
    }

    .pack-list-title {
      color: #2e1065;
      font-size: 0.88rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .pack-list-meta {
      color: #6b7280;
      font-size: 0.79rem;
      line-height: 1.45;
    }

    .pack-empty {
      color: #6b7280;
      font-size: 0.86rem;
      padding: 8px 2px;
    }

    .pack-complete-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .pack-section-card {
      border: 1px solid #e9d5ff;
      border-radius: 12px;
      background: #ffffff;
      padding: 12px;
    }

    .pack-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      width: 100%;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      margin-bottom: 8px;
      text-align: left;
    }

    .pack-section-caret {
      color: #7c3aed;
      font-size: 0.8rem;
      font-weight: 700;
      transition: transform 0.2s ease;
    }

    .pack-section-card.collapsed .pack-section-caret {
      transform: rotate(-90deg);
    }

    .pack-section-body {
      display: block;
    }

    .pack-section-card.collapsed .pack-section-body {
      display: none;
    }

    .pack-section-title {
      font-size: 0.82rem;
      color: #2e1065;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
    }

    .pack-section-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .pack-section-grid.info-scroll {
      max-height: 192px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .pack-line {
      border-bottom: 1px dashed #ede9fe;
      padding-bottom: 6px;
    }

    .pack-line:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .pack-line-label {
      font-size: 0.72rem;
      color: #3b1a75;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .pack-line-value {
      font-size: 0.82rem;
      color: #1f2937;
      word-break: break-word;
    }

    .pack-sections-controls {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .pack-sections-controls button {
      border: 1px solid #ddd6fe;
      border-radius: 8px;
      background: #fff;
      color: #5b21b6;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 6px 10px;
      cursor: pointer;
    }

    .pack-sections-controls button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .pack-sections-page {
      font-size: 0.76rem;
      color: #6b7280;
      font-weight: 600;
      min-width: 78px;
      text-align: center;
    }

    .pack-details-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px 20px;
    }

    .pack-details-field {
      font-size: 0.85rem;
      color: #111827;
    }

    .pack-details-label {
      display: block;
      font-size: 0.75rem;
      color: #5b21b6;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .pack-details-block {
      border-left: 3px solid #5b21b6;
      padding-left: 12px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: #111827;
    }

    @media screen and (max-width: 768px) {
      .pack-details-grid {
        grid-template-columns: 1fr;
      }

      .pack-kv-grid {
        grid-template-columns: 1fr;
      }

      .pack-complete-grid {
        grid-template-columns: 1fr;
      }
    }

    .filter-count {
      margin-left: 5px;
      opacity: 0.8;
    }

    /* Timeline */
    .timeline {
      padding: 25px;
    }

    .timeline-header {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 30px;
    }

    .timeline-item {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 19px;
      top: 50px;
      width: 2px;
      height: calc(100% - 30px);
      background: #e5e7eb;
    }

    .timeline-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .timeline-icon svg {
      width: 20px;
      height: 20px;
      fill: var(--primary);
    }

    .timeline-icon.blue {
      background: var(--primary-soft);
    }

    .timeline-icon.blue svg {
      fill: var(--primary);
    }

    .timeline-content {
      flex: 1;
      padding-top: 5px;
    }

    .timeline-title {
      font-size: 0.95rem;
      color: #111827;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .timeline-title a {
      color: var(--primary);
      text-decoration: none;
    }

    .timeline-title a:hover {
      text-decoration: underline;
    }

    .timeline-meta {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #9ca3af;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .timeline-meta svg {
      width: 14px;
      height: 14px;
      fill: #9ca3af;
    }

    .timeline-details {
      margin-top: 10px;
      padding: 12px;
      background: var(--surface-soft);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .timeline-details-toggle {
      color: #6b7280;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .timeline-details-content {
      color: #6b7280;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .timeline-time {
      position: absolute;
      right: 0;
      top: 5px;
      color: #9ca3af;
      font-size: 0.85rem;
    }

    .timeline-table-title {
      font-size: 0.82rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .timeline-table-wrap {
      overflow-x: auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
    }

    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 560px;
    }

    .timeline-table th,
    .timeline-table td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .timeline-table th {
      background: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    /* Holdings Cards */
    .holdings-view {
      display: none;
      padding: 25px;
    }

    .holdings-view.active {
      display: block;
    }

    .holdings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .holdings-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    .holdings-header span {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .holdings-section {
      margin-bottom: 18px;
    }

    .holdings-section-toggle {
      width: 100%;
      border: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 4px 2px;
      text-align: left;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }

    .holdings-section-toggle:hover {
      background: #f7f2ff;
    }

    .holdings-section-title {
      font-size: 0.82rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      margin: 0;
    }

    .holdings-section-chevron {
      color: var(--text-muted);
      font-size: 0.9rem;
      transition: transform 0.24s ease;
    }

    .holdings-section-content {
      max-height: 3000px;
      opacity: 1;
      overflow: hidden;
      transition: max-height 0.35s ease, opacity 0.25s ease, margin-top 0.25s ease;
      margin-top: 8px;
    }

    .holdings-section.collapsed .holdings-section-content {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }

    .holdings-section.collapsed .holdings-section-chevron {
      transform: rotate(-90deg);
    }

    .holding-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 14px;
      background: #ffffff;
      transition: box-shadow 0.2s ease;
    }

    .holding-card:hover {
      box-shadow: 0 6px 16px rgba(17, 24, 39, 0.08);
    }

    .holding-card-muted {
      border-style: dashed;
      border-color: #d1d5db;
      background: #f9fafb;
      box-shadow: none;
    }

    .holding-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .holding-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .holding-price {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      text-align: right;
    }

    .holding-change {
      font-size: 0.8rem;
      font-weight: 600;
      text-align: right;
      color: #10b981;
      margin-top: 2px;
    }

    .holding-desc {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .holding-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .holding-tag {
      background: #f3f4f6;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: #4b5563;
      font-weight: 600;
    }

    .holding-icons {
      display: flex;
      align-items: center;
    }

    .holding-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.7rem;
      color: #ffffff;
      margin-left: -8px;
    }

    .holding-icon:first-child {
      margin-left: 0;
    }

    .icon-orange { background: #ea580c; }
    .icon-gold { background: #d97706; }
    .icon-brown { background: #92400e; }
    .icon-green { background: #059669; }
    .icon-blue { background: #2563eb; }
    .icon-lightblue { background: #0ea5e9; }
    .icon-gray { background: #6b7280; }
    .icon-purple { background: #7c3aed; }
    .icon-red { background: #dc2626; }
    .icon-pink { background: #db2777; }

    .holding-count {
      font-size: 0.8rem;
      color: #6b7280;
      margin-left: 6px;
    }

    .holding-label {
      font-size: 0.8rem;
      color: #9ca3af;
      font-weight: 600;
      margin-left: 4px;
    }

    .holdings-empty-state {
      border: 1px dashed #c4b5fd;
      border-radius: 16px;
      background: linear-gradient(180deg, #faf5ff 0%, #f9fafb 100%);
      min-height: 190px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #6b7280;
      gap: 8px;
      margin-bottom: 14px;
      padding: 18px;
    }

    .holdings-empty-state.active {
      display: flex;
    }

    .holdings-empty-state svg {
      width: 34px;
      height: 34px;
      fill: #7c3aed;
    }

    .holdings-empty-state strong {
      font-size: 0.96rem;
      color: #4b5563;
      font-weight: 600;
    }

    .holdings-empty-state p {
      margin: 0;
      font-size: 0.84rem;
      color: #9ca3af;
      max-width: 320px;
      line-height: 1.45;
    }

    /* Phone modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-card {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      padding: 24px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: #111827;
    }

    .modal-close {
      border: none;
      background: #f3f4f6;
      color: #6b7280;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .modal-body label {
      font-size: 0.9rem;
      color: #374151;
      font-weight: 500;
    }

    .modal-body input {
      height: 42px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 0 12px;
      font-size: 0.9rem;
      outline: none;
    }

    .modal-body input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .image-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 320px;
      overflow-y: auto;
    }

    .image-list button {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-width: 0;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.9rem;
      color: #111827;
    }

    .image-list button:hover {
      background: #f9fafb;
    }

    .image-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: left;
      flex: 1;
      min-width: 0;
      max-width: 100%;
    }

    .image-meta strong {
      display: block;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image-meta small {
      color: #6b7280;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .image-actions button {
      border: 1px solid #e5e7eb;
      background: #ffffff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #111827;
    }

    .image-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .image-actions button:hover {
      background: #f9fafb;
    }

    .modal-actions small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .modal-btn {
      height: 38px;
      padding: 0 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-btn.primary {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    /* Responsive */
    @media screen and (max-width: 1200px) {
      .content-area {
        flex-direction: column;
      }

      .left-column {
        flex: 1;
        width: 100%;
      }
    }

    @media screen and (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .main-content {
        margin-left: 0;
      }

      .content-area {
        padding: 20px;
      }

      .simple-view {
        padding: 18px 20px 24px;
      }

      .simple-view-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .user-count-wrap {
        width: 100%;
      }

      .quick-filter-row {
        width: 100%;
      }

      .top-nav {
        padding: 15px 20px;
      }

      .company-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .company-actions {
        width: 100%;
      }

      .action-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="/icon.png" alt="App logo" style="width: 32px; height: 32px;" />
    </div>

    <nav class="sidebar-nav">
      <a class="nav-icon" href="/dashboard.html" aria-label="Dashboard">
        <svg viewBox="0 0 24 24">
          <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
      </a>

      <a class="nav-icon" href="/index.html" aria-label="Profiles">
        <svg viewBox="0 0 24 24">
          <path d="M12 12c1.66 0 3-1.34 3-3S13.66 6 12 6 9 7.34 9 9s1.34 3 3 3zm0 2c-2.22 0-6 1.11-6 3.33V19h12v-1.67C18 15.11 14.22 14 12 14z"/>
        </svg>
      </a>

      <a class="nav-icon" href="#" aria-label="Settings">
        <svg viewBox="0 0 24 24">
          <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.62l-1.92-3.32c-.11-.2-.36-.28-.58-.2l-2.39.96c-.5-.38-1.05-.7-1.66-.94l-.36-2.54A.488.488 0 0 0 14.9 2h-3.8c-.24 0-.44.17-.48.4l-.36 2.54c-.61.24-1.16.56-1.66.94l-2.39-.96a.5.5 0 0 0-.58.2L3.7 8.44c-.11.21-.06.48.12.62l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.62l1.92 3.32c.11.2.36.28.58.2l2.39-.96c.5.38 1.05.7 1.66.94l.36 2.54c.04.23.24.4.48.4h3.8c.24 0 .44-.17.48-.4l.36-2.54c.61-.24 1.16-.56 1.66-.94l2.39.96c.22.08.47 0 .58-.2l1.92-3.32a.5.5 0 0 0-.12-.62l-2.03-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5S10.07 8.5 12 8.5s3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
        </svg>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation -->
    <div class="top-nav">
      <div class="top-search">
        <input type="search" placeholder="Search profiles..." aria-label="Search profiles">
      </div>

      <div class="top-nav-actions">
        <button class="signout-btn" id="signOutBtn">Sign out</button>
      </div>
    </div>

    <section class="simple-view" id="simpleView">
      <div class="simple-view-header">
        <h2 class="simple-view-title">Profiles</h2>
        <div class="user-count-wrap">
          <div class="quick-filter-row" aria-label="User filters">
            <button class="quick-filter-pill active" type="button" data-kyc-pill="all">All</button>
            <button class="quick-filter-pill" type="button" data-kyc-pill="completed">Completed</button>
            <button class="quick-filter-pill" type="button" data-kyc-pill="pending">Pending</button>
            <button class="quick-filter-pill" type="button" data-kyc-pill="not-completed">Not completed</button>
            <div class="bank-filter-wrap">
              <button class="quick-filter-pill" id="bankFilterBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="bankFilterMenu">Bank ▾</button>
              <div class="bank-filter-menu" id="bankFilterMenu" role="menu" aria-label="Bank filter">
                <button class="bank-filter-option active" type="button" data-bank-filter="all" role="menuitem">All banks</button>
                <button class="bank-filter-option" type="button" data-bank-filter="linked" role="menuitem">Linked bank</button>
                <button class="bank-filter-option" type="button" data-bank-filter="unlinked" role="menuitem">Unlinked bank</button>
              </div>
            </div>
          </div>
          <button class="user-count-badge" id="userCountBadge" type="button" aria-live="polite" aria-atomic="true">
            <span class="user-count-dot" aria-hidden="true"></span>
            <span class="user-count-number" id="userCount">0</span>
            <span id="userCountLabel">users</span>
          </button>
        </div>
      </div>
      <div class="simple-list" id="profilesList"></div>

      <template id="profileItemTemplate">
        <div class="simple-item">
          <div class="simple-row">
            <div class="simple-left">
              <div class="simple-avatar" data-initials>AA</div>
              <div class="simple-text">
                <div class="simple-name" data-name>Alex Adams</div>
                <div class="simple-uid" data-uid>UID: AA-0000-XX</div>
              </div>
            </div>
            <div class="simple-right">
              <span class="sumsub-review-pulse" data-review-pulse aria-hidden="true"></span>
              <button class="ellipsis-btn show-details-btn" aria-label="Show profile details">
                <svg viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="detailed-view">
            <div class="content-area">
            <div class="left-column">
              <div class="company-header">
                <div class="company-info">
                  <div class="company-avatar" data-company-avatar>
                    <svg viewBox="0 0 24 24">
                      <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                  </div>
                  <div class="company-title">
                    <h1>
                      <span data-name>Alex Adams</span>
                      <svg class="info-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                      </svg>
                    </h1>
                  </div>
                </div>

                <div class="detail-row" style="padding-top: 0; border-bottom: none;">
                  <div class="detail-label">UID</div>
                  <div class="detail-value" data-uid>UID: AA-0000-XX</div>
                </div>
              </div>

              <div class="detail-card">
                <div class="card-header">
                  <div class="card-title">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Company details
                  </div>
                  <button class="card-action">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                  </button>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Contact Address</div>
                  <div class="detail-value" data-address>174 Quai de Jemmapes</div>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Created at</div>
                  <div class="detail-value" data-created>Not added</div>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Email</div>
                  <div class="detail-value" data-website>bb.agency</div>
                </div>
              </div>

              <div class="detail-card">
                <div class="card-header">
                  <div class="card-title">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Contact details
                  </div>
                  <button class="card-action phone-add-btn" aria-label="Add phone number">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                  </button>
                </div>

                <div class="detail-row">
                  <div class="detail-label">Phone number</div>
                  <div class="detail-value" data-phone>Not added</div>
                </div>
              </div>
            </div>

            <div class="right-column">
              <div class="tabs-container">
                <div class="tabs-header">
                  <div class="tab">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    KYC: <span data-kyc-status>Not initiated</span>
                  </div>
                  <div class="tab active" data-pack="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 3c.55 0 1 .45 1 1v8.17l2.59-2.58 1.41 1.41L12 17l-5-5 1.41-1.41L11 12.17V4c0-.55.45-1 1-1zm-7 14h14v2H5v-2z"/>
                    </svg>
                    Pack
                  </div>
                  <button class="tab kyc-images-btn" type="button" data-images="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm1 7V3.5L18.5 9H15z"/>
                    </svg>
                    Documents
                  </button>
                </div>

                <div class="filter-tabs">
                  <button class="filter-tab active" data-view="history">
                    History
                  </button>
                  <button class="filter-tab" data-view="holdings">
                    Current holdings
                  </button>
                  <button class="pack-details-btn" type="button" data-pack-details data-view="pack-details">
                    Client details
                  </button>
                </div>

                <div class="timeline history-view">
                  <h2 class="timeline-header">History</h2>

                  <div class="timeline-item">
                    <div class="timeline-icon blue">
                      <svg viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        File has been uploaded <a href="#">my-cool-file.jpg</a>
                        <svg style="width: 16px; height: 16px; fill: #9ca3af; margin-left: 5px;" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Added by: Lora Adams
                      </div>
                      <div class="timeline-time">2 hours ago</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon">
                      <svg viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        Triggered an event <span style="color: #dc2626;">webinar-email-follow-up</span>
                      </div>
                      <div class="timeline-details-toggle">
                        Hide data ˄
                      </div>
                      <div class="timeline-details">
                        <div class="timeline-details-content">
                          <strong>source</strong> Christmas Promotion Website
                        </div>
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Triggered by: John Lock
                      </div>
                      <div class="timeline-time">December 14, 2023 at 3:31 PM</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon blue">
                      <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-title">
                        Meeting scheduled
                      </div>
                      <div class="timeline-meta">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Scheduled by: Sarah Chen
                      </div>
                      <div class="timeline-time">Yesterday</div>
                    </div>
                  </div>
                </div>

                <div class="holdings-view">
                  <div class="holdings-header">
                    <h2>Current holdings</h2>
                    <span data-holdings-summary>Showing 5 of 5</span>
                  </div>

                  <div class="holdings-empty-state" data-holdings-empty>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M10 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V9l-6-6h-5zm0 2h4.17L19 9.83V19H5V5h5zm2 3a4 4 0 100 8 4 4 0 000-8zm0 2.2A1.8 1.8 0 1110.2 12 1.8 1.8 0 0112 10.2z"/>
                    </svg>
                    <strong>No holdings allocated</strong>
                    <p>This user has no current allocations yet. Holdings will appear here once allocation data is available.</p>
                  </div>

                  <div class="holdings-section">
                    <button class="holdings-section-toggle" type="button" aria-expanded="true">
                      <span class="holdings-section-title">Strategy</span>
                      <span class="holdings-section-chevron">▾</span>
                    </button>

                    <div class="holdings-section-content" data-holdings-strategy>
                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Income Defensive</div>
                          </div>
                          <div>
                            <div class="holding-price">R 104.20</div>
                            <div class="holding-change">+0.00%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Low • A conservative income focused strategy p...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Low</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-orange">C</div>
                              <div class="holding-icon icon-gold">G</div>
                              <div class="holding-icon icon-brown">⬡</div>
                            </div>
                            <span class="holding-count">+7</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Balanced Core</div>
                          </div>
                          <div>
                            <div class="holding-price">R 108.45</div>
                            <div class="holding-change">+0.01%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Balanced • A diversified South African strategy focu...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Balanced</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-green">S</div>
                              <div class="holding-icon icon-blue">E</div>
                              <div class="holding-icon icon-lightblue">G</div>
                            </div>
                            <span class="holding-count">+2</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Blended Focus</div>
                          </div>
                          <div>
                            <div class="holding-price">R 132.80</div>
                            <div class="holding-change">+0.03%</div>
                          </div>
                        </div>
                        <div class="holding-desc">High • A blended, fundamentally driven JSE equi...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">High</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-gray">⬡</div>
                              <div class="holding-icon icon-brown">A</div>
                              <div class="holding-icon icon-purple">OU</div>
                            </div>
                            <span class="holding-count">+6</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="holdings-section">
                    <button class="holdings-section-toggle" type="button" aria-expanded="true">
                      <span class="holdings-section-title">Individual stocks</span>
                      <span class="holdings-section-chevron">▾</span>
                    </button>

                    <div class="holdings-section-content" data-holdings-stocks>
                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">Famous Brands</div>
                          </div>
                          <div>
                            <div class="holding-price">R 125.60</div>
                            <div class="holding-change">+0.01%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Growth • A high growth equity strategy targeting ...</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Growth</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-gray">C</div>
                              <div class="holding-icon icon-blue">K</div>
                              <div class="holding-icon icon-pink">M</div>
                            </div>
                            <span class="holding-count">+6</span>
                            <span class="holding-label">Holdings</span>
                          </div>
                        </div>
                      </div>

                      <div class="holding-card">
                        <div class="holding-header">
                          <div>
                            <div class="holding-title">TechNova Systems</div>
                          </div>
                          <div>
                            <div class="holding-price">R 89.35</div>
                            <div class="holding-change">+0.06%</div>
                          </div>
                        </div>
                        <div class="holding-desc">Momentum • Mid-cap technology stock with strong quarterly growth.</div>
                        <div class="holding-footer">
                          <div class="holding-tag">Momentum</div>
                          <div class="holdings-container">
                            <div class="holding-icons">
                              <div class="holding-icon icon-purple">TN</div>
                              <div class="holding-icon icon-lightblue">AI</div>
                            </div>
                            <span class="holding-count">+1</span>
                            <span class="holding-label">Stock</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="pack-details-view" data-pack-details-view>
                  <div class="pack-details-card">
                    <div class="pack-details-title">Client details</div>
                    <div class="pack-details-grid" id="packDetailsGrid"></div>
                  </div>
                  <div class="pack-details-card" id="packDetailsDocs"></div>
                  <div class="pack-details-card" id="packDetailsReview"></div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </template>
    </section>
  </main>

  <div class="modal-overlay" id="phoneModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Add phone number</div>
        <button class="modal-close" id="phoneModalClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <label for="phoneInput">Phone number</label>
        <input id="phoneInput" type="tel" placeholder="e.g. +27 82 123 4567">
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="phoneModalCancel">Cancel</button>
        <button class="modal-btn primary" id="phoneModalSave">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="imageModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Select document</div>
        <button class="modal-close" id="imageModalClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="image-list" id="imageList"></div>
      </div>
      <div class="modal-actions">
        <small>Tip: You can preview or download any document directly.</small>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://mfxnghmuccevsxwcetej.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1meG5naG11Y2NldnN4d2NldGVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NTI1ODAsImV4cCI6MjA4NDQyODU4MH0.lktfglzBMaHd79hLFDRH1HHSwsEwZ56Tv6e287kQiFg';
    const PROFILES_TABLE = 'profiles';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const profilesList = document.getElementById('profilesList');
    const profileTemplate = document.getElementById('profileItemTemplate');
    const userCount = document.getElementById('userCount');
    const userCountLabel = document.getElementById('userCountLabel');
    const userCountBadge = document.getElementById('userCountBadge');
    const kycFilterPills = Array.from(document.querySelectorAll('[data-kyc-pill]'));
    const bankFilterBtn = document.getElementById('bankFilterBtn');
    const bankFilterMenu = document.getElementById('bankFilterMenu');
    const bankFilterOptions = Array.from(document.querySelectorAll('[data-bank-filter]'));
    const searchInput = document.querySelector('.top-search input');
    const activeProfileFilters = {
      kyc: 'all',
      bank: 'all'
    };
    let allProfiles = [];
    let allKycMap = {};
    const onboardingMap = {};
    const packDetailsRowMap = {};
    const allocationsByUserMap = {};
    const holdingsByUserMap = {};
    const securitiesByIdMap = {};
    const PACK_SECTIONS_PAGE_SIZE = 4;

    const getInitials = (name = '') => {
      const parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'NA';
      return parts.slice(0, 2).map(part => part[0].toUpperCase()).join('');
    };

    const setText = (root, selector, value) => {
      const resolved = value === undefined || value === null || value === '' ? 'Not added' : value;
      root.querySelectorAll(selector).forEach(el => {
        el.textContent = resolved;
      });
    };

    const phoneModal = document.getElementById('phoneModal');
    const phoneInput = document.getElementById('phoneInput');
    const phoneModalClose = document.getElementById('phoneModalClose');
    const phoneModalCancel = document.getElementById('phoneModalCancel');
    const phoneModalSave = document.getElementById('phoneModalSave');
    let activePhoneItem = null;

    const imageModal = document.getElementById('imageModal');
    const imageList = document.getElementById('imageList');
    const imageModalClose = document.getElementById('imageModalClose');
    let activeInspectionId = null;
    let activeImages = [];
    const packJsonMap = {};

    const openPhoneModal = (item) => {
      activePhoneItem = item;
      if (phoneInput) phoneInput.value = '';
      if (phoneModal) phoneModal.classList.add('active');
    };

    const closePhoneModal = () => {
      activePhoneItem = null;
      if (phoneModal) phoneModal.classList.remove('active');
    };

    const openImageModal = (inspectionId, images) => {
      activeInspectionId = inspectionId;
      activeImages = images;
      if (!imageModal || !imageList) return;
      imageList.innerHTML = '';

      images.forEach((img, index) => {
        const imageId = img?.id || img?.previewId || img?.imageId || img?.resourceId;
        if (!imageId) return;
        const button = document.createElement('button');
        const fileName = img?.fileMetadata?.fileName || `Document ${index + 1}`;
        const fileType = img?.fileMetadata?.fileType || 'Unknown type';
        const addedDate = img?.addedDate || img?.createdAt || '';

        button.type = 'button';
        button.dataset.imageId = imageId;
        button.innerHTML = `
          <span class="image-meta">
            <strong title="${escapeHtml(fileName)}">${escapeHtml(fileName)}</strong>
            <small>${fileType}${addedDate ? ` • ${addedDate}` : ''}</small>
          </span>
          <span class="image-actions">
            <button type="button" data-action="download">Download</button>
          </span>
        `;

        const downloadButton = button.querySelector('[data-action="download"]');
        if (downloadButton) {
          downloadButton.addEventListener('click', async (downloadEvent) => {
            downloadEvent.stopPropagation();
            if (!activeInspectionId || !imageId) return;
            try {
              const blob = await fetchApplicantImage(activeInspectionId, imageId);
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              link.remove();
              URL.revokeObjectURL(url);
            } catch (error) {
              console.error('Sumsub download error:', error);
            }
          });
        }

        button.addEventListener('click', () => {
          if (!activeInspectionId || !imageId) return;
          fetchApplicantImage(activeInspectionId, imageId)
            .then((imageBlob) => {
              const imageUrl = URL.createObjectURL(imageBlob);
              window.open(imageUrl, '_blank', 'noopener');
              setTimeout(() => URL.revokeObjectURL(imageUrl), 15000);
            })
            .catch((error) => {
              console.error('Sumsub image error:', error);
            });
        });

        imageList.appendChild(button);
      });

      imageModal.classList.add('active');
    };

    const closeImageModal = () => {
      activeInspectionId = null;
      activeImages = [];
      if (imageModal) imageModal.classList.remove('active');
      if (imageList) imageList.innerHTML = '';
    };

    const formatFieldValue = (value) => {
      if (value === null || value === undefined || value === '') return 'Not provided';
      if (Array.isArray(value)) return value.join(', ');
      if (typeof value === 'object') return JSON.stringify(value);
      return String(value);
    };

    const formatRelativeTime = (value) => {
      if (!value) return 'Date unavailable';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return String(value);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const minute = 60 * 1000;
      const hour = 60 * minute;
      const day = 24 * hour;

      if (diffMs < minute) return 'Just now';
      if (diffMs < hour) return `${Math.floor(diffMs / minute)} min ago`;
      if (diffMs < day) return `${Math.floor(diffMs / hour)} hours ago`;
      if (diffMs < day * 7) return `${Math.floor(diffMs / day)} days ago`;
      return date.toLocaleString();
    };

    const escapeHtml = (value) => String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const formatNumber = (value, digits = 2) => {
      if (value === null || value === undefined || value === '') return '-';
      const parsed = Number(value);
      if (Number.isNaN(parsed)) return String(value);
      return parsed.toLocaleString(undefined, {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    };

    const getLatestTimestamp = (rows = []) => {
      let latest = null;
      rows.forEach((row) => {
        const candidate = row?.updated_at || row?.created_at || row?.as_of_date;
        if (!candidate) return;
        if (!latest || new Date(candidate).getTime() > new Date(latest).getTime()) {
          latest = candidate;
        }
      });
      return latest;
    };

    const buildAllocationsTableHtml = (rows = []) => {
      const body = rows.map(row => `
        <tr>
          <td>${escapeHtml(row.asset_class || '-')}</td>
          <td>${formatNumber(row.weight, 2)}%</td>
          <td>R ${formatNumber(row.value, 2)}</td>
          <td>${escapeHtml(row.as_of_date || '-')}</td>
        </tr>
      `).join('');

      return `
        <div class="timeline-table-title">Allocations</div>
        <div class="timeline-table-wrap">
          <table class="timeline-table">
            <thead>
              <tr>
                <th>Asset class</th>
                <th>Weight</th>
                <th>Value</th>
                <th>As of</th>
              </tr>
            </thead>
            <tbody>${body}</tbody>
          </table>
        </div>
      `;
    };

    const buildHoldingsTableHtml = (rows = []) => {
      const body = rows.map(row => {
        const security = securitiesByIdMap[row.security_id] || {};
        const label = security.symbol || security.name || row.security_id || '-';
        return `
          <tr>
            <td>${escapeHtml(label)}</td>
            <td>${formatNumber(row.quantity, 2)}</td>
            <td>R ${formatNumber(row.avg_fill, 2)}</td>
            <td>R ${formatNumber(row.market_value, 2)}</td>
            <td>R ${formatNumber(row.unrealized_pnl, 2)}</td>
            <td>${escapeHtml(row.Status || '-')}</td>
            <td>${escapeHtml(row.as_of_date || '-')}</td>
          </tr>
        `;
      }).join('');

      return `
        <div class="timeline-table-title">Holdings</div>
        <div class="timeline-table-wrap">
          <table class="timeline-table">
            <thead>
              <tr>
                <th>Security</th>
                <th>Quantity</th>
                <th>Avg fill</th>
                <th>Market value</th>
                <th>Unrealized PnL</th>
                <th>Status</th>
                <th>As of</th>
              </tr>
            </thead>
            <tbody>${body}</tbody>
          </table>
        </div>
      `;
    };

    const buildTimelineItemHtml = ({ title, meta, time, details, blue = false }) => `
      <div class="timeline-item">
        <div class="timeline-icon${blue ? ' blue' : ''}">
          <svg viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14l-4-4 1.41-1.41L11 13.17l4.59-4.58L17 10l-6 6z"/>
          </svg>
        </div>
        <div class="timeline-content">
          <div class="timeline-title">${title}</div>
          ${details ? `
            <div class="timeline-details-toggle">Show data ˅</div>
            <div class="timeline-details" style="display: none;">
              <div class="timeline-details-content">${details}</div>
            </div>
          ` : ''}
          <div class="timeline-meta">
            <svg viewBox="0 0 24 24">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            ${meta}
          </div>
          <div class="timeline-time">${time}</div>
        </div>
      </div>
    `;

    const renderHistoryForItem = (item, profile, kycEntry, onboardingRow, packRow) => {
      const historyView = item?.querySelector('.history-view');
      if (!historyView) return;

      const events = [];
      const userAllocations = allocationsByUserMap[profile?.id] || [];
      const userHoldings = holdingsByUserMap[profile?.id] || [];

      if (profile?.created_at) {
        events.push({
          at: profile.created_at,
          title: 'Profile created',
          meta: 'System',
          details: `UID: ${profile.id || 'N/A'}`,
          blue: true
        });
      }

      const effectiveKyc = getEffectiveKycState(profile?.id, kycEntry?.status || 'Not initiated');
      if (kycEntry?.status || effectiveKyc.completed || effectiveKyc.pending) {
        events.push({
          at: onboardingRow?.updated_at || onboardingRow?.created_at || profile?.created_at,
          title: effectiveKyc.completed ? 'KYC status now completed' : `KYC status updated to ${effectiveKyc.label}`,
          meta: onboardingRow?.user_id ? 'Sumsub sync' : 'KYC workflow',
          details: onboardingRow?.user_id ? `External user id: ${onboardingRow.user_id}` : '',
          blue: effectiveKyc.completed
        });
      }

      if (packRow?.pack_details || packJsonMap[profile?.id]) {
        events.push({
          at: packRow?.updated_at || packRow?.created_at || new Date().toISOString(),
          title: 'Client details available',
          meta: 'Saved to user_onboarding_pack_details',
          details: 'Pack JSON has been fetched and stored for this user.',
          blue: true
        });
      }

      if (profile?.phone_number) {
        events.push({
          at: profile?.updated_at || profile?.created_at,
          title: 'Contact phone on file',
          meta: 'Profile details',
          details: profile.phone_number,
          blue: false
        });
      }

      if (userAllocations.length) {
        events.push({
          at: getLatestTimestamp(userAllocations) || profile?.updated_at || profile?.created_at,
          title: `Allocations snapshot (${userAllocations.length})`,
          meta: 'allocations table',
          details: buildAllocationsTableHtml(userAllocations),
          blue: true
        });
      }

      if (userHoldings.length) {
        events.push({
          at: getLatestTimestamp(userHoldings) || profile?.updated_at || profile?.created_at,
          title: `Holdings snapshot (${userHoldings.length})`,
          meta: 'stock_holdings table',
          details: buildHoldingsTableHtml(userHoldings),
          blue: true
        });
      }

      const sorted = events
        .filter(event => event.at)
        .sort((a, b) => new Date(b.at).getTime() - new Date(a.at).getTime());

      if (!sorted.length) {
        historyView.innerHTML = `
          <h2 class="timeline-header">History</h2>
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-title">No history available for this user yet.</div>
              <div class="timeline-time">-</div>
            </div>
          </div>
        `;
        return;
      }

      historyView.innerHTML = `
        <h2 class="timeline-header">History</h2>
        ${sorted.map(event => buildTimelineItemHtml({
          title: event.title,
          meta: event.meta,
          time: formatRelativeTime(event.at),
          details: event.details,
          blue: event.blue
        })).join('')}
      `;
    };

    const setPackDetailsEnabled = (item, enabled) => {
      if (!item) return;
      const btn = item.querySelector('[data-pack-details]');
      if (btn) btn.disabled = !enabled;
    };

    const pickPackValue = (source, paths = []) => {
      for (const path of paths) {
        const parts = path.split('.');
        let current = source;
        for (const part of parts) {
          if (current === null || current === undefined) {
            current = undefined;
            break;
          }
          current = current[part];
        }
        if (current !== undefined && current !== null && current !== '') {
          return current;
        }
      }
      return null;
    };

    const extractPhoneFromPack = (pack = {}) => {
      const raw = pickPackValue(pack, [
        'phone',
        'phoneNumber',
        'phone_number',
        'mobile',
        'mobilePhone',
        'info.phone',
        'info.phoneNumber',
        'info.mobile',
        'fixedInfo.phone',
        'fixedInfo.phoneNumber',
        'fixedInfo.mobile',
        'contacts.phone',
        'contact.phone'
      ]);

      if (raw === null || raw === undefined) return '';
      return String(raw).trim();
    };

    const syncPhoneFromPack = async (item, packJson, options = {}) => {
      const persistToDb = options.persistToDb !== false;
      const profileId = item?.dataset?.profileId;
      if (!item || !profileId || !packJson) return;

      const phoneFromPack = extractPhoneFromPack(packJson);
      if (!phoneFromPack) return;

      const phoneEl = item.querySelector('[data-phone]');
      if (phoneEl) phoneEl.textContent = phoneFromPack;

      const currentProfile = allProfiles.find(profile => String(profile.id) === String(profileId));
      const existingPhone = String(currentProfile?.phone_number || '').trim();
      if (currentProfile) {
        currentProfile.phone_number = phoneFromPack;
      }

      if (!persistToDb || existingPhone === phoneFromPack) return;

      const { error } = await supabaseClient
        .from('profiles')
        .update({ phone_number: phoneFromPack })
        .eq('id', profileId);

      if (error) {
        console.error('Phone sync from pack failed:', error);
        return;
      }

      if (currentProfile) {
        renderHistoryForItem(item, currentProfile, allKycMap[profileId] || {}, onboardingMap[profileId], packDetailsRowMap[profileId]);
      }
    };

    const normalizeKycStatusText = (value) => String(value || '').trim().toLowerCase();

    const isKycCompletedValue = (status) => {
      const normalized = normalizeKycStatusText(status);
      if (!normalized) return false;
      return normalized.includes('completed')
        || normalized.includes('complete')
        || normalized.includes('approved')
        || normalized.includes('verified')
        || normalized.includes('done');
    };

    const isKycPendingValue = (status) => {
      const normalized = normalizeKycStatusText(status);
      if (!normalized) return false;
      return normalized.includes('pending')
        || normalized.includes('in progress')
        || normalized.includes('in_progress')
        || normalized.includes('review')
        || normalized.includes('processing')
        || normalized.includes('queued');
    };

    const getClientDetailsKycSignal = (profileId) => {
      const packData = packJsonMap[profileId] || packDetailsRowMap[profileId]?.pack_details || null;
      if (!packData) {
        return {
          hasClientDetails: false,
          completed: false,
          pending: false,
          rejected: false,
          pulse: null,
          reviewAnswer: ''
        };
      }

      const reviewAnswerRaw = pickPackValue(packData, [
        'review.result.reviewAnswer',
        'review.reviewAnswer',
        'reviewAnswer'
      ]);
      const reviewStatusRaw = pickPackValue(packData, [
        'review.reviewStatus',
        'reviewStatus',
        'status'
      ]);
      const reviewAnswer = String(reviewAnswerRaw || '').trim().toUpperCase();
      const reviewStatus = String(reviewStatusRaw || '').trim().toLowerCase();

      const isGreen = reviewAnswer === 'GREEN';
      const isYellow = reviewAnswer === 'YELLOW' || reviewAnswer === 'ORANGE';
      const isRed = reviewAnswer === 'RED';
      const completedFromStatus = reviewStatus.includes('completed') || reviewStatus.includes('approved');
      const pendingFromStatus = reviewStatus.includes('pending') || reviewStatus.includes('init') || reviewStatus.includes('review') || reviewStatus.includes('process');

      const pulse = isGreen ? 'green' : (isYellow ? 'yellow' : (isRed ? 'red' : null));

      return {
        hasClientDetails: true,
        completed: isGreen || (!isYellow && !isRed && completedFromStatus),
        pending: isYellow || (!isRed && !isGreen && pendingFromStatus),
        rejected: isRed,
        pulse,
        reviewAnswer
      };
    };

    const getEffectiveKycState = (profileId, rawKycStatus) => {
      const normalizedKycStatus = normalizeKycStatusText(rawKycStatus);
      const clientDetailsKyc = getClientDetailsKycSignal(profileId);
      const rejected = clientDetailsKyc.rejected || normalizedKycStatus.includes('reject');
      const explicitPendingFromReview = !rejected && clientDetailsKyc.pending;
      const explicitCompletedFromReview = !rejected && !explicitPendingFromReview && clientDetailsKyc.completed;
      const pendingLooksStale = normalizedKycStatus.includes('pending')
        && clientDetailsKyc.hasClientDetails
        && clientDetailsKyc.completed;
      const completed = explicitCompletedFromReview || (!rejected && !explicitPendingFromReview && (isKycCompletedValue(rawKycStatus)
        || clientDetailsKyc.completed
        || pendingLooksStale));
      const pending = explicitPendingFromReview || (!rejected && !completed && isKycPendingValue(rawKycStatus));
      return {
        rejected,
        completed,
        pending,
        label: rejected ? 'Rejected' : (completed ? 'Completed' : (pending ? 'Pending' : (rawKycStatus || 'Not initiated')))
      };
    };

    const updateReviewPulseForItem = (item, profileId) => {
      if (!item || !profileId) return;
      const pulseEl = item.querySelector('[data-review-pulse]');
      if (!pulseEl) return;

      const signal = getClientDetailsKycSignal(profileId);
      pulseEl.classList.remove('active', 'green', 'yellow', 'red');
      pulseEl.removeAttribute('title');

      if (!signal?.pulse) return;

      pulseEl.classList.add('active', signal.pulse);
      const title = signal.pulse === 'green'
        ? 'KYC review answer: GREEN'
        : signal.pulse === 'yellow'
          ? 'KYC review answer: YELLOW'
          : 'KYC review answer: RED';
      pulseEl.setAttribute('title', title);
    };

    const toPrettyLabel = (key = '') => String(key)
      .replace(/_/g, ' ')
      .replace(/([a-z])([A-Z])/g, '$1 $2')
      .replace(/\s+/g, ' ')
      .trim()
      .replace(/\b\w/g, char => char.toUpperCase());

    const normalizeDocuments = (pack = {}) => {
      const directDocuments = pickPackValue(pack, ['documents', 'docs', 'documentSet.items']);
      if (Array.isArray(directDocuments)) return directDocuments;

      const reviews = pickPackValue(pack, ['review.reviewResult.reviewAnswer', 'review']) || null;
      const fallback = pickPackValue(pack, ['requiredIdDocs.docSets', 'requiredIdDocs']) || null;

      if (Array.isArray(fallback)) {
        return fallback.flatMap((entry) => {
          if (Array.isArray(entry?.items)) return entry.items;
          return [entry];
        });
      }

      if (reviews && typeof reviews === 'object') {
        return Object.entries(reviews).map(([key, value]) => ({
          type: key,
          value
        }));
      }

      return [];
    };

    const flattenPackEntries = (value, path = [], acc = []) => {
      if (value === null || value === undefined) {
        if (path.length) acc.push({ path, value: '-' });
        return acc;
      }

      if (Array.isArray(value)) {
        if (!value.length) {
          acc.push({ path, value: '[]' });
          return acc;
        }
        value.forEach((item, index) => {
          flattenPackEntries(item, [...path, `[${index}]`], acc);
        });
        return acc;
      }

      if (typeof value === 'object') {
        const entries = Object.entries(value);
        if (!entries.length) {
          acc.push({ path, value: '{}' });
          return acc;
        }
        entries.forEach(([key, nested]) => {
          flattenPackEntries(nested, [...path, key], acc);
        });
        return acc;
      }

      acc.push({ path, value });
      return acc;
    };

    const formatPackPrimitive = (value) => {
      if (value === null || value === undefined || value === '') return '-';
      if (typeof value === 'boolean') return value ? 'Yes' : 'No';
      return formatFieldValue(value);
    };

    const getPackLeafLabel = (segments = []) => {
      const nonIndexSegments = segments.filter(segment => !String(segment).startsWith('['));
      const target = nonIndexSegments[nonIndexSegments.length - 1] || segments[segments.length - 1] || 'Value';
      return toPrettyLabel(String(target).replace(/\[\d+\]/g, 'Item'));
    };

    const buildCompletePackSections = (pack = {}) => {
      const flattened = flattenPackEntries(pack);
      const hiddenRootSections = new Set([
        'id',
        'key',
        'lang',
        'type',
        'notes',
        'agreement',
        'review',
        'creationinfo',
        'requirediddocs'
      ]);
      const grouped = flattened.reduce((acc, entry) => {
        const [root = 'General', ...rest] = entry.path;
        const normalizedRoot = String(root || '').toLowerCase();
        if (hiddenRootSections.has(normalizedRoot)) return acc;
        if (!acc[root]) acc[root] = [];
        acc[root].push({
          label: rest.length ? getPackLeafLabel(rest) : toPrettyLabel(root),
          value: formatPackPrimitive(entry.value)
        });
        return acc;
      }, {});

      return Object.entries(grouped).map(([section, rows]) => ({
        key: String(section || 'general').toLowerCase(),
        title: toPrettyLabel(section),
        rows
      }));
    };

    const renderPackSectionRows = (sectionRows = []) => sectionRows.map((row) => `
      <div class="pack-line">
        <div class="pack-line-label">${escapeHtml(row.label)}</div>
        <div class="pack-line-value">${escapeHtml(String(row.value))}</div>
      </div>
    `).join('');

    const renderPackSectionCards = (container, page = 0) => {
      const sections = container?.__packSections || [];
      const sectionsGrid = container?.querySelector('[data-pack-sections-grid]');
      const pageLabel = container?.querySelector('[data-pack-sections-page]');
      const prevBtn = container?.querySelector('[data-pack-sections-prev]');
      const nextBtn = container?.querySelector('[data-pack-sections-next]');
      if (!sectionsGrid || !pageLabel || !prevBtn || !nextBtn) return;

      const totalPages = Math.max(1, Math.ceil(sections.length / PACK_SECTIONS_PAGE_SIZE));
      const safePage = Math.max(0, Math.min(page, totalPages - 1));
      container.__packSectionsPage = safePage;

      const start = safePage * PACK_SECTIONS_PAGE_SIZE;
      const visible = sections.slice(start, start + PACK_SECTIONS_PAGE_SIZE);

      sectionsGrid.innerHTML = visible.map((section, index) => {
        const absoluteIndex = start + index;
        const isInfoSection = section.key === 'info';
        return `
          <div class="pack-section-card" data-pack-section-index="${absoluteIndex}">
            <button class="pack-section-header pack-section-toggle" type="button" data-pack-section-toggle aria-expanded="true">
              <div class="pack-section-title">${escapeHtml(section.title)}</div>
              <span class="pack-section-caret">▾</span>
            </button>
            <div class="pack-section-body">
              <div class="pack-section-grid${isInfoSection ? ' info-scroll' : ''}">
                ${renderPackSectionRows(section.rows)}
              </div>
            </div>
          </div>
        `;
      }).join('');

      pageLabel.textContent = `Page ${safePage + 1} / ${totalPages}`;
      prevBtn.disabled = safePage <= 0;
      nextBtn.disabled = safePage >= totalPages - 1;
    };

    const buildPackPdfReport = (pack, sections = []) => {
      const JsPdf = window.jspdf?.jsPDF;
      if (!JsPdf || !pack) return null;

      const doc = new JsPdf({ unit: 'pt', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      const contentWidth = pageWidth - (margin * 2);
      const footerGap = 36;
      let y = margin;

      const firstName = pickPackValue(pack, ['info.firstName', 'fixedInfo.firstName', 'firstName']);
      const lastName = pickPackValue(pack, ['info.lastName', 'fixedInfo.lastName', 'lastName']);
      const nameFromPack = pickPackValue(pack, ['fullName', 'info.fullName', 'fixedInfo.fullName', 'applicant.fullName']);
      const displayName = String(nameFromPack || [firstName, lastName].filter(Boolean).join(' ') || 'User').trim();

      const ensureSpace = (neededHeight = 20) => {
        if (y + neededHeight <= pageHeight - footerGap) return;
        doc.addPage();
        y = margin;
      };

      const drawHeader = () => {
        const headerHeight = 90;
        doc.setFillColor(245, 240, 255);
        doc.roundedRect(margin, y, contentWidth, headerHeight, 12, 12, 'F');

        doc.setTextColor(55, 65, 81);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        const headerName = doc.splitTextToSize(displayName, contentWidth - 28);
        doc.text(headerName, margin + 14, y + 34);

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(11);
        doc.setTextColor(107, 114, 128);
        doc.text('Client details', margin + 14, y + 58);

        doc.setFontSize(9);
        doc.setTextColor(124, 58, 237);
        doc.text(`Generated ${new Date().toLocaleString()}`, margin + 14, y + 76);

        y += headerHeight + 16;
      };

      const drawSummaryCard = () => {
        const summaryRows = [
          ['Applicant ID', formatPackPrimitive(pickPackValue(pack, ['id', 'applicantId']))],
          ['External user ID', formatPackPrimitive(pickPackValue(pack, ['externalUserId', 'external_user_id']))],
          ['Review status', formatPackPrimitive(pickPackValue(pack, ['review.reviewStatus', 'reviewStatus', 'status']))],
          ['Decision', formatPackPrimitive(pickPackValue(pack, ['review.result.reviewAnswer', 'review.reviewAnswer', 'reviewAnswer']))],
          ['Country', formatPackPrimitive(pickPackValue(pack, ['country', 'info.country', 'fixedInfo.country']))],
          ['Contact', formatPackPrimitive(pickPackValue(pack, ['email', 'info.email', 'fixedInfo.email']))]
        ];

        const rowHeight = 22;
        const cardHeight = 42 + (summaryRows.length * rowHeight);
        ensureSpace(cardHeight + 10);

        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(229, 231, 235);
        doc.roundedRect(margin, y, contentWidth, cardHeight, 10, 10, 'FD');

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(31, 41, 55);
        doc.text('Summary', margin + 14, y + 22);

        let rowY = y + 36;
        summaryRows.forEach(([label, value]) => {
          doc.setDrawColor(243, 244, 246);
          doc.line(margin + 12, rowY, margin + contentWidth - 12, rowY);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.setTextColor(75, 85, 99);
          doc.text(String(label), margin + 14, rowY + 15);

          doc.setFont('helvetica', 'normal');
          doc.setTextColor(31, 41, 55);
          const valueLines = doc.splitTextToSize(String(value), contentWidth - 190);
          doc.text(valueLines, margin + 180, rowY + 15);
          rowY += rowHeight;
        });

        y += cardHeight + 14;
      };

      const drawSectionTitle = (title) => {
        ensureSpace(30);
        doc.setFillColor(237, 233, 254);
        doc.roundedRect(margin, y, contentWidth, 24, 8, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(91, 33, 182);
        doc.text(String(title), margin + 12, y + 16);
        y += 30;
      };

      const drawSectionRow = (label, value) => {
        const labelX = margin + 12;
        const valueX = margin + 190;
        const valueMaxWidth = contentWidth - 206;
        const valueLines = doc.splitTextToSize(String(value), valueMaxWidth);
        const rowHeight = Math.max(20, (valueLines.length * 12) + 8);
        ensureSpace(rowHeight + 2);

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(75, 85, 99);
        doc.text(String(label), labelX, y + 12);

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(17, 24, 39);
        doc.text(valueLines, valueX, y + 12);

        doc.setDrawColor(243, 244, 246);
        doc.line(margin + 10, y + rowHeight, margin + contentWidth - 10, y + rowHeight);
        y += rowHeight + 2;
      };

      drawHeader();
      drawSummaryCard();

      sections.forEach((section) => {
        if (!section?.rows?.length) return;
        drawSectionTitle(section.title || 'Section');
        section.rows.forEach((row) => {
          drawSectionRow(row.label || 'Field', formatFieldValue(row.value));
        });
        y += 6;
      });

      const filenameBase = formatPackPrimitive(pickPackValue(pack, ['externalUserId', 'id', 'applicantId', 'fullName']))
        .toString()
        .replace(/[^a-zA-Z0-9_-]/g, '_') || 'user';
      return {
        doc,
        filename: `pack-report-${filenameBase}.pdf`
      };
    };

    const downloadPackPdf = (pack, sections = []) => {
      const report = buildPackPdfReport(pack, sections);
      if (!report) return;
      report.doc.save(report.filename);
    };

    const renderPackDetails = (container, packJson) => {
      if (!container) return;
      const packDetailsGrid = container.querySelector('#packDetailsGrid');
      const packDetailsDocs = container.querySelector('#packDetailsDocs');
      const packDetailsReview = container.querySelector('#packDetailsReview');
      if (!packDetailsGrid || !packDetailsDocs || !packDetailsReview) return;

      let resolvedPack = packJson;
      if (typeof resolvedPack === 'string') {
        try {
          resolvedPack = JSON.parse(resolvedPack);
        } catch (error) {
          console.error('Pack details parse error:', error);
        }
      }

      if (!resolvedPack) {
        container.__activePackDetails = null;
        container.__packSections = [];
        container.__packSectionsPage = 0;
        packDetailsGrid.innerHTML = '<div class="pack-details-field">No client details available for this user.</div>';
        packDetailsDocs.innerHTML = '';
        packDetailsReview.innerHTML = '';
        return;
      }

      const applicantId = pickPackValue(resolvedPack, ['id', 'applicantId', 'applicant.id']);
      const externalUserId = pickPackValue(resolvedPack, ['externalUserId', 'external_user_id']);
      const reviewStatus = pickPackValue(resolvedPack, ['review.status', 'reviewStatus', 'status']);
      const reviewAnswer = pickPackValue(resolvedPack, ['review.result.reviewAnswer', 'review.reviewAnswer', 'reviewAnswer']);
      const createdAt = pickPackValue(resolvedPack, ['createdAt', 'created_at']);
      const country = pickPackValue(resolvedPack, ['country', 'info.country', 'fixedInfo.country']);
      const email = pickPackValue(resolvedPack, ['email', 'info.email', 'fixedInfo.email']);
      const fullName = pickPackValue(resolvedPack, ['fullName', 'info.fullName', 'fixedInfo.fullName', 'info.firstName']);
      const profileId = container.closest('.simple-item')?.dataset?.profileId;
      const profileItem = container.closest('.simple-item');
      const effectiveKyc = profileId
        ? getEffectiveKycState(profileId, allKycMap[profileId]?.status || 'Not initiated')
        : null;
      const badgeLabel = effectiveKyc?.completed ? 'Completed' : String(reviewStatus || 'Pending');
      const completeSections = buildCompletePackSections(resolvedPack);

      container.__activePackDetails = resolvedPack;
      container.__packSections = completeSections;
      container.__packSectionsPage = 0;

      const overviewPairs = [
        ['Applicant ID', applicantId],
        ['External user ID', externalUserId],
        ['Review status', reviewStatus],
        ['Decision', reviewAnswer],
        ['Created', createdAt ? new Date(createdAt).toLocaleString() : null],
        ['Country', country],
        ['Contact', email],
        ['Name', fullName],
      ].filter(([, value]) => value !== null && value !== undefined && value !== '');

      const overviewHtml = overviewPairs.map(([label, value]) => `
        <div class="pack-kv-item">
          <div class="pack-kv-label">${escapeHtml(label)}</div>
          <div class="pack-kv-value">${escapeHtml(formatFieldValue(value))}</div>
        </div>
      `).join('');

      packDetailsGrid.innerHTML = `
        <div class="pack-details-card purple">
          <div class="pack-hero">
            <div>
              <div class="pack-hero-title">Verification pack summary</div>
              <div class="pack-hero-subtitle">Complete record from user_onboarding_pack_details</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <button type="button" class="pack-download-btn" data-pack-download>Download PDF</button>
              <div class="pack-badge">${escapeHtml(badgeLabel)}</div>
            </div>
          </div>
          <div class="pack-kv-grid">${overviewHtml || '<div class="pack-empty">No summary fields available.</div>'}</div>
          <div class="pack-complete-grid" data-pack-sections-grid></div>
          <div class="pack-sections-controls">
            <button type="button" data-pack-sections-prev>Prev</button>
            <div class="pack-sections-page" data-pack-sections-page>Page 1 / 1</div>
            <button type="button" data-pack-sections-next>Next</button>
          </div>
        </div>
      `;

      renderPackSectionCards(container, 0);

      packDetailsDocs.classList.remove('purple');
      packDetailsReview.classList.remove('purple');
      packDetailsDocs.style.display = 'none';
      packDetailsReview.style.display = 'none';
      packDetailsDocs.innerHTML = '';
      packDetailsReview.innerHTML = '';

      if (profileItem) {
        syncPhoneFromPack(profileItem, resolvedPack, { persistToDb: true })
          .catch((error) => console.error('Phone sync from rendered pack failed:', error));
      }
    };

    const renderProfiles = (profiles = [], kycMap = {}) => {
      if (!profilesList || !profileTemplate) return;
      profilesList.innerHTML = '';
      const totalUsers = profiles.length;
      if (userCount) userCount.textContent = String(totalUsers);
      if (userCountLabel) userCountLabel.textContent = totalUsers === 1 ? 'user' : 'users';

      profiles.forEach(profile => {
        const clone = profileTemplate.content.firstElementChild.cloneNode(true);
        const fullName = [profile.first_name, profile.last_name].filter(Boolean).join(' ') || 'Unknown User';
        const uid = profile.id;

        if (profile.id) {
          clone.dataset.profileId = profile.id;
        }

        setText(clone, '[data-name]', fullName);
        setText(clone, '[data-uid]', `UID: ${uid}`);
        setText(clone, '[data-company]', fullName);
        setText(clone, '[data-city]', profile.city);
        setText(clone, '[data-country]', profile.country);
        setText(clone, '[data-address]', profile.address);
        setText(clone, '[data-created]', profile.created_at);
        setText(clone, '[data-website]', profile.email);
        setText(clone, '[data-phone]', profile.phone_number);
        const kycEntry = kycMap[profile.id] || {};
        const effectiveKycState = getEffectiveKycState(profile.id, kycEntry.status || 'Not initiated');
        setText(clone, '[data-kyc-status]', effectiveKycState.label);
        updateReviewPulseForItem(clone, profile.id);

        const initialsEl = clone.querySelector('[data-initials]');
        if (initialsEl) {
          if (profile.avatar_url) {
            initialsEl.textContent = '';
            initialsEl.style.backgroundImage = `url('${profile.avatar_url}')`;
            initialsEl.style.backgroundSize = 'cover';
            initialsEl.style.backgroundPosition = 'center';
            initialsEl.style.color = 'transparent';
          } else {
            initialsEl.textContent = getInitials(fullName);
          }
        }

        const companyAvatar = clone.querySelector('[data-company-avatar]');
        if (companyAvatar && profile.avatar_url) {
          companyAvatar.innerHTML = '';
          companyAvatar.style.backgroundImage = `url('${profile.avatar_url}')`;
          companyAvatar.style.backgroundSize = 'cover';
          companyAvatar.style.backgroundPosition = 'center';
        }

        if (kycEntry.externalUserId) {
          clone.dataset.externalUserId = kycEntry.externalUserId;
        }

        renderHistoryForItem(clone, profile, kycEntry, onboardingMap[profile.id], packDetailsRowMap[profile.id]);
        renderHoldingsForItem(clone, profile.id);

        if (packJsonMap[profile.id]) {
          const packBtn = clone.querySelector('[data-pack-details]');
          if (packBtn) packBtn.disabled = false;
        }

        profilesList.appendChild(clone);
      });
    };

    const applySearchFilter = () => {
      const query = searchInput?.value?.trim().toLowerCase() || '';

      const isTruthyBankValue = (value) => {
        if (value === true) return true;
        if (typeof value === 'number') return value > 0;
        if (typeof value !== 'string') return false;
        const normalized = normalizeKycStatusText(value);
        if (!normalized) return false;
        if (['true', 'yes', '1', 'linked', 'connected', 'initiated', 'completed', 'active', 'verified', 'success'].includes(normalized)) {
          return true;
        }
        if (normalized.includes('not') || normalized.includes('pending') || normalized.includes('failed') || normalized.includes('none')) {
          return false;
        }
        return normalized.includes('linked') || normalized.includes('connected') || normalized.includes('initiated') || normalized.includes('complete');
      };

      const getBankInitiatedForProfile = (profile) => {
        const profileId = profile?.id;
        const onboardingRow = onboardingMap[profileId] || {};
        const candidateKeys = [
          'bank_initiated',
          'bankInitiated',
          'is_bank_initiated',
          'bank_linked',
          'bankLinked',
          'is_bank_linked',
          'bank_connected',
          'bankConnected',
          'bank_status',
          'bankStatus',
          'banking_status',
          'bank_account_status',
          'bank_account_linked',
          'bank_started'
        ];

        for (const key of candidateKeys) {
          if (onboardingRow[key] !== undefined) {
            return isTruthyBankValue(onboardingRow[key]);
          }
          if (profile?.[key] !== undefined) {
            return isTruthyBankValue(profile[key]);
          }
        }

        for (const [key, value] of Object.entries(onboardingRow)) {
          if (String(key).toLowerCase().includes('bank') && isTruthyBankValue(value)) {
            return true;
          }
        }

        for (const [key, value] of Object.entries(profile || {})) {
          if (String(key).toLowerCase().includes('bank') && isTruthyBankValue(value)) {
            return true;
          }
        }

        return false;
      };

      const filtered = allProfiles.filter(profile => {
        const fullName = [profile.first_name, profile.last_name].filter(Boolean).join(' ');
        const uid = profile.id || '';
        const matchesQuery = !query
          || fullName.toLowerCase().includes(query)
          || String(uid).toLowerCase().includes(query);

        const kycStatus = allKycMap[profile.id]?.status || 'Not initiated';
        const effectiveKycState = getEffectiveKycState(profile.id, kycStatus);
        const matchesKyc = activeProfileFilters.kyc === 'all'
          || (activeProfileFilters.kyc === 'completed' && effectiveKycState.completed)
          || (activeProfileFilters.kyc === 'pending' && effectiveKycState.pending)
          || (activeProfileFilters.kyc === 'not-completed' && !effectiveKycState.completed);

        const bankInitiated = getBankInitiatedForProfile(profile);
        const matchesBank = activeProfileFilters.bank === 'all'
          || (activeProfileFilters.bank === 'linked' && bankInitiated)
          || (activeProfileFilters.bank === 'unlinked' && !bankInitiated);

        return matchesQuery && matchesKyc && matchesBank;
      });

      renderProfiles(filtered, allKycMap);
    };

    const renderHoldingAllocationCard = (row) => {
      const title = row.asset_class || 'Strategy allocation';
      const asOf = row.as_of_date || '-';
      const weight = Number.isFinite(Number(row.weight)) ? `${formatNumber(row.weight, 2)}%` : '-';
      const value = row.value === null || row.value === undefined ? 'R -' : `R ${formatNumber(row.value, 2)}`;
      const return1d = row.return_1d === null || row.return_1d === undefined
        ? '-'
        : `${Number(row.return_1d) >= 0 ? '+' : ''}${formatNumber(row.return_1d, 3)}%`;

      return `
        <div class="holding-card">
          <div class="holding-header">
            <div>
              <div class="holding-title">${escapeHtml(title)}</div>
            </div>
            <div>
              <div class="holding-price">${escapeHtml(value)}</div>
              <div class="holding-change">${escapeHtml(return1d)}</div>
            </div>
          </div>
          <div class="holding-desc">Weight ${escapeHtml(weight)} • As of ${escapeHtml(asOf)}</div>
          <div class="holding-footer">
            <div class="holding-tag">${escapeHtml(row.asset_class || 'Strategy')}</div>
            <div class="holdings-container">
              <span class="holding-label">Allocation</span>
            </div>
          </div>
        </div>
      `;
    };

    const renderStockHoldingCard = (row) => {
      const security = securitiesByIdMap[row.security_id] || {};
      const title = security.name || security.symbol || row.security_id || 'Stock holding';
      const asOf = row.as_of_date || '-';
      const quantity = row.quantity === null || row.quantity === undefined ? '-' : formatNumber(row.quantity, 2);
      const marketValue = row.market_value === null || row.market_value === undefined ? 'R -' : `R ${formatNumber(row.market_value, 2)}`;
      const pnl = row.unrealized_pnl === null || row.unrealized_pnl === undefined
        ? '-'
        : `${Number(row.unrealized_pnl) >= 0 ? '+' : ''}R ${formatNumber(row.unrealized_pnl, 2)}`;

      return `
        <div class="holding-card">
          <div class="holding-header">
            <div>
              <div class="holding-title">${escapeHtml(title)}</div>
            </div>
            <div>
              <div class="holding-price">${escapeHtml(marketValue)}</div>
              <div class="holding-change">${escapeHtml(pnl)}</div>
            </div>
          </div>
          <div class="holding-desc">Quantity ${escapeHtml(quantity)} • As of ${escapeHtml(asOf)}</div>
          <div class="holding-footer">
            <div class="holding-tag">${escapeHtml(row.Status || 'Stock')}</div>
            <div class="holdings-container">
              <span class="holding-label">Holding</span>
            </div>
          </div>
        </div>
      `;
    };

    const renderHoldingsForItem = (item, profileId) => {
      if (!item || !profileId) return;
      const holdingsView = item.querySelector('.holdings-view');
      if (!holdingsView) return;

      const summaryEl = holdingsView.querySelector('[data-holdings-summary]');
      const emptyStateEl = holdingsView.querySelector('[data-holdings-empty]');
      const strategyContainer = holdingsView.querySelector('[data-holdings-strategy]');
      const stocksContainer = holdingsView.querySelector('[data-holdings-stocks]');
      const sections = Array.from(holdingsView.querySelectorAll('.holdings-section'));
      if (!summaryEl || !emptyStateEl || !strategyContainer || !stocksContainer) return;

      const strategyRows = (allocationsByUserMap[profileId] || []).slice();
      strategyRows.sort((a, b) => new Date(b.updated_at || b.created_at || 0).getTime() - new Date(a.updated_at || a.created_at || 0).getTime());

      const stockRows = (holdingsByUserMap[profileId] || []).slice();
      stockRows.sort((a, b) => new Date(b.updated_at || b.created_at || 0).getTime() - new Date(a.updated_at || a.created_at || 0).getTime());

      const total = strategyRows.length + stockRows.length;
      summaryEl.textContent = total ? `Showing ${total} holding${total === 1 ? '' : 's'}` : 'Showing 0 holdings';

      if (!total) {
        emptyStateEl.classList.add('active');
        sections.forEach(section => {
          section.style.display = 'none';
        });
        strategyContainer.innerHTML = '';
        stocksContainer.innerHTML = '';
        return;
      }

      emptyStateEl.classList.remove('active');
      sections.forEach(section => {
        section.style.display = '';
      });

      strategyContainer.innerHTML = strategyRows.length
        ? strategyRows.map(row => renderHoldingAllocationCard(row)).join('')
        : '<div class="holding-card holding-card-muted"><div class="holding-desc">No strategy allocations.</div></div>';

      stocksContainer.innerHTML = stockRows.length
        ? stockRows.map(row => renderStockHoldingCard(row)).join('')
        : '<div class="holding-card holding-card-muted"><div class="holding-desc">No stock holdings.</div></div>';
    };

    const loadProfiles = async () => {
      Object.keys(onboardingMap).forEach(key => delete onboardingMap[key]);
      Object.keys(packDetailsRowMap).forEach(key => delete packDetailsRowMap[key]);
      Object.keys(allocationsByUserMap).forEach(key => delete allocationsByUserMap[key]);
      Object.keys(holdingsByUserMap).forEach(key => delete holdingsByUserMap[key]);
      Object.keys(securitiesByIdMap).forEach(key => delete securitiesByIdMap[key]);

      const { data, error } = await supabaseClient
        .from(PROFILES_TABLE)
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Supabase load error:', error);
        return;
      }

      const profiles = data || [];
      const userIds = profiles.map(profile => profile.id).filter(Boolean);
      let kycMap = {};

      if (userIds.length) {
        const { data: onboarding, error: onboardingError } = await supabaseClient
          .from('user_onboarding')
          .select('*')
          .in('user_id', userIds);

        if (!onboardingError && onboarding) {
          kycMap = onboarding.reduce((acc, row) => {
            acc[row.user_id] = {
              status: row.kyc_status || 'Not initiated',
              externalUserId: row.user_id || ''
            };
            onboardingMap[row.user_id] = row;
            return acc;
          }, {});
        }

        const { data: packRows, error: packError } = await supabaseClient
          .from('user_onboarding_pack_details')
          .select('*')
          .in('user_id', userIds);

        if (!packError && packRows) {
          packRows.forEach(row => {
            packDetailsRowMap[row.user_id] = row;
            if (row.user_id && row.pack_details) {
              packJsonMap[row.user_id] = row.pack_details;
            }
          });
        }

        const { data: allocationsRows, error: allocationsError } = await supabaseClient
          .from('allocations')
          .select('user_id, asset_class, weight, value, return_1d, return_1w, return_1m, return_ytd, return_1y, as_of_date, security_id, created_at, updated_at')
          .in('user_id', userIds)
          .order('updated_at', { ascending: false });

        if (!allocationsError && allocationsRows) {
          allocationsRows.forEach((row) => {
            if (!allocationsByUserMap[row.user_id]) allocationsByUserMap[row.user_id] = [];
            allocationsByUserMap[row.user_id].push(row);
          });
        }

        const { data: holdingsRows, error: holdingsError } = await supabaseClient
          .from('stock_holdings')
          .select('user_id, security_id, quantity, avg_fill, market_value, unrealized_pnl, Status, as_of_date, created_at, updated_at')
          .in('user_id', userIds)
          .order('updated_at', { ascending: false });

        if (!holdingsError && holdingsRows) {
          holdingsRows.forEach((row) => {
            if (!holdingsByUserMap[row.user_id]) holdingsByUserMap[row.user_id] = [];
            holdingsByUserMap[row.user_id].push(row);
          });

          const securityIds = [...new Set([
            ...holdingsRows.map(row => row.security_id),
            ...(allocationsRows || []).map(row => row.security_id)
          ].filter(Boolean))];
          if (securityIds.length) {
            const { data: securityRows, error: securitiesError } = await supabaseClient
              .from('securities')
              .select('id, symbol, name')
              .in('id', securityIds);

            if (!securitiesError && securityRows) {
              securityRows.forEach((security) => {
                securitiesByIdMap[security.id] = security;
              });
            }
          }
        }
      }

      allProfiles = profiles;
      allKycMap = kycMap;
      renderProfiles(allProfiles, allKycMap);
      applySearchFilter();
    };

    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        window.location.href = '/signin.html';
        return false;
      }
      return true;
    };

    const downloadJson = (data, filename) => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const downloadBlobFile = (blob, filename) => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const sanitizeFilename = (value = '') => String(value || '')
      .trim()
      .replace(/[\\/:*?"<>|]+/g, '_')
      .replace(/\s+/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_+|_+$/g, '');

    const resolveMetadataItems = (metadata) => {
      const items = Array.isArray(metadata)
        ? metadata
        : (metadata?.resources || metadata?.items || metadata?.images || metadata?.data?.resources || [metadata]);
      return Array.isArray(items) ? items.filter(Boolean) : [];
    };

    const resolveImageId = (item) => item?.id || item?.previewId || item?.imageId || item?.resourceId;

    const resolveDocumentFileName = (item, index) => {
      const metadataName = item?.fileMetadata?.fileName;
      const fallbackName = item?.label || item?.name || `document-${index + 1}`;
      const rawName = metadataName || fallbackName;
      const safeName = sanitizeFilename(rawName) || `document-${index + 1}`;
      return safeName.includes('.') ? safeName : `${safeName}.bin`;
    };

    const persistPackForProfile = async (item, applicantJson) => {
      const profileId = item?.dataset?.profileId;
      if (!profileId || !applicantJson) return;

      packJsonMap[profileId] = applicantJson;
      packDetailsRowMap[profileId] = {
        ...(packDetailsRowMap[profileId] || {}),
        user_id: profileId,
        pack_details: applicantJson,
        updated_at: new Date().toISOString()
      };

      setPackDetailsEnabled(item, true);
      const kycStatusEl = item.querySelector('[data-kyc-status]');
      if (kycStatusEl) {
        const effectiveKyc = getEffectiveKycState(profileId, allKycMap[profileId]?.status || 'Not initiated');
        kycStatusEl.textContent = effectiveKyc.label;
      }

      const currentProfile = allProfiles.find(profile => String(profile.id) === String(profileId));
      if (currentProfile) {
        renderHistoryForItem(item, currentProfile, allKycMap[profileId] || {}, onboardingMap[profileId], packDetailsRowMap[profileId]);
      }

      await syncPhoneFromPack(item, applicantJson, { persistToDb: true });
      updateReviewPulseForItem(item, profileId);

      const kycStatusEl = item.querySelector('[data-kyc-status]');
      if (kycStatusEl) {
        const effectiveKyc = getEffectiveKycState(profileId, allKycMap[profileId]?.status || 'Not initiated');
        kycStatusEl.textContent = effectiveKyc.label;
      }

      supabaseClient
        .from('user_onboarding_pack_details')
        .upsert({ user_id: profileId, pack_details: applicantJson }, { onConflict: 'user_id' })
        .then(({ error }) => {
          if (error) console.error('Pack details save error:', error);
        });
    };

    const refreshAndDownloadPackZip = async (item) => {
      const externalUserId = item?.dataset?.externalUserId;
      const profileId = item?.dataset?.profileId;
      if (!externalUserId) {
        console.warn('No Sumsub external user id found for this profile.');
        return;
      }

      const JsZip = window.JSZip;
      if (!JsZip) {
        console.error('JSZip is not available.');
        return;
      }

      const applicant = await fetchApplicantByExternalId(externalUserId);
      await persistPackForProfile(item, applicant);

      const applicantId = applicant?.id || applicant?.applicantId || applicant?.applicant_id;
      if (!applicantId) {
        throw new Error('No applicantId found in Sumsub response.');
      }

      const metadata = await fetchApplicantMetadata(applicantId);
      const inspectionId = applicant?.inspectionId || applicant?.review?.inspectionId || findFirstValueByKeys(applicant, ['inspectionId']);
      const items = resolveMetadataItems(metadata);

      const safeBase = sanitizeFilename(externalUserId || profileId || applicantId || 'pack') || 'pack';
      const zip = new JsZip();
      zip.file(`sumsub-${safeBase}.json`, JSON.stringify(applicant, null, 2));
      const pdfSections = buildCompletePackSections(applicant);
      const pdfReport = buildPackPdfReport(applicant, pdfSections);
      if (pdfReport) {
        zip.file(pdfReport.filename, pdfReport.doc.output('blob'));
      }

      if (inspectionId && items.length) {
        const docsFolder = zip.folder('documents');
        const usedNames = new Map();

        const fetchPromises = items.map(async (docItem, index) => {
          const imageId = resolveImageId(docItem);
          if (!imageId) return;

          try {
            const blob = await fetchApplicantImage(inspectionId, imageId);
            const baseName = resolveDocumentFileName(docItem, index);
            const duplicateCount = usedNames.get(baseName) || 0;
            usedNames.set(baseName, duplicateCount + 1);
            const finalName = duplicateCount === 0
              ? baseName
              : `${baseName.replace(/(\.[^.]*)?$/, '')}-${duplicateCount + 1}${baseName.match(/(\.[^.]*)$/)?.[1] || ''}`;
            docsFolder.file(finalName, blob);
          } catch (error) {
            console.error('Document download failed:', error);
          }
        });

        await Promise.all(fetchPromises);
      }

      const zipBlob = await zip.generateAsync({ type: 'blob' });
      downloadBlobFile(zipBlob, `pack-bundle-${safeBase}.zip`);
    };

    const refreshPackDataOnly = async (item) => {
      const externalUserId = item?.dataset?.externalUserId;
      if (!externalUserId) {
        console.warn('No Sumsub external user id found for this profile.');
        return null;
      }
      const applicant = await fetchApplicantByExternalId(externalUserId);
      await persistPackForProfile(item, applicant);
      return applicant;
    };

    const fetchApplicantByExternalId = async (externalUserId) => {
      const res = await fetch(`/api/sumsub/applicant?externalUserId=${encodeURIComponent(externalUserId)}`);
      if (!res.ok) {
        throw new Error(`Applicant fetch failed: ${res.status}`);
      }
      return res.json();
    };

    const fetchApplicantMetadata = async (applicantId) => {
      const res = await fetch(`/api/sumsub/metadata?applicantId=${encodeURIComponent(applicantId)}`);
      if (!res.ok) {
        throw new Error(`Metadata fetch failed: ${res.status}`);
      }
      return res.json();
    };

    const fetchApplicantImage = async (inspectionId, imageId) => {
      const res = await fetch(`/api/sumsub/image?inspectionId=${encodeURIComponent(inspectionId)}&imageId=${encodeURIComponent(imageId)}`);
      if (!res.ok) {
        throw new Error(`Image fetch failed: ${res.status}`);
      }
      return res.blob();
    };

    const findFirstValueByKeys = (value, keys) => {
      if (!value || typeof value !== 'object') return null;
      if (Array.isArray(value)) {
        for (const item of value) {
          const found = findFirstValueByKeys(item, keys);
          if (found) return found;
        }
        return null;
      }
      for (const key of keys) {
        if (value[key]) return value[key];
      }
      for (const child of Object.values(value)) {
        const found = findFirstValueByKeys(child, keys);
        if (found) return found;
      }
      return null;
    };


    document.addEventListener('click', (event) => {
      const packDownloadBtn = event.target.closest('[data-pack-download]');
      if (packDownloadBtn) {
        const container = packDownloadBtn.closest('.tabs-container');
        const pack = container?.__activePackDetails;
        const sections = container?.__packSections || [];
        if (!pack) return;
        downloadPackPdf(pack, sections);
        return;
      }

      const prevSectionsBtn = event.target.closest('[data-pack-sections-prev]');
      if (prevSectionsBtn) {
        const container = prevSectionsBtn.closest('.tabs-container');
        const currentPage = Number(container?.__packSectionsPage || 0);
        renderPackSectionCards(container, currentPage - 1);
        return;
      }

      const nextSectionsBtn = event.target.closest('[data-pack-sections-next]');
      if (nextSectionsBtn) {
        const container = nextSectionsBtn.closest('.tabs-container');
        const currentPage = Number(container?.__packSectionsPage || 0);
        renderPackSectionCards(container, currentPage + 1);
        return;
      }

      const packSectionToggle = event.target.closest('[data-pack-section-toggle]');
      if (packSectionToggle) {
        const card = packSectionToggle.closest('.pack-section-card');
        if (!card) return;
        const isCollapsed = card.classList.toggle('collapsed');
        packSectionToggle.setAttribute('aria-expanded', String(!isCollapsed));
        return;
      }

      const tab = event.target.closest('.tab');
      if (tab) {
        const header = tab.closest('.tabs-header');
        if (!header) return;
        header.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (tab.dataset.pack === 'true') {
          const item = tab.closest('.simple-item');
          const externalUserId = item?.dataset?.externalUserId;
          if (!externalUserId) {
            console.warn('No Sumsub external user id found for this profile.');
            return;
          }
          if (tab.classList.contains('is-loading')) return;
          tab.classList.add('is-loading');
          refreshAndDownloadPackZip(item)
            .catch(err => console.error('Sumsub error:', err))
            .finally(() => {
              tab.classList.remove('is-loading');
            });
        }

        if (tab.dataset.images === 'true') {
          const item = tab.closest('.simple-item');
          const externalUserId = item?.dataset?.externalUserId;
          if (!externalUserId) {
            console.warn('No Sumsub external user id found for this profile.');
            return;
          }

          (async () => {
            try {
              const applicant = await fetchApplicantByExternalId(externalUserId);
              const applicantId = applicant?.id || applicant?.applicantId || applicant?.applicant_id;
              if (!applicantId) {
                console.warn('No applicantId found in Sumsub response.');
                return;
              }

              const metadata = await fetchApplicantMetadata(applicantId);
              const inspectionId = applicant?.inspectionId || applicant?.review?.inspectionId || findFirstValueByKeys(applicant, ['inspectionId']);
              const items = Array.isArray(metadata)
                ? metadata
                : (metadata?.resources || metadata?.items || metadata?.images || metadata?.data?.resources || [metadata]);

              if (!inspectionId || !items.length) {
                console.warn('Missing inspectionId or image list from responses.', { inspectionId, metadata });
                return;
              }

              openImageModal(inspectionId, items);
            } catch (error) {
              console.error('Sumsub image error:', error);
            }
          })();
        }
      }

      const filterTab = event.target.closest('.filter-tab, [data-pack-details]');
      if (filterTab) {
        const filterGroup = filterTab.closest('.filter-tabs');
        if (!filterGroup) return;
        filterGroup.querySelectorAll('.filter-tab, [data-pack-details]').forEach(t => t.classList.remove('active'));
        filterTab.classList.add('active');

        const container = filterTab.closest('.tabs-container');
        if (!container) return;
        const historyView = container.querySelector('.history-view');
        const holdingsView = container.querySelector('.holdings-view');
        const packDetailsView = container.querySelector('[data-pack-details-view]');
        const view = filterTab.getAttribute('data-view');
        if (historyView) {
          historyView.style.display = view === 'history' ? 'block' : 'none';
        }
        if (holdingsView) {
          holdingsView.classList.toggle('active', view === 'holdings');
        }
        if (packDetailsView) {
          packDetailsView.classList.toggle('active', view === 'pack-details');
        }

        if (view === 'pack-details') {
          const item = filterTab.closest('.simple-item');
          const profileId = item?.dataset?.profileId;
          const externalUserId = item?.dataset?.externalUserId;
          const packJson = profileId ? packJsonMap[profileId] : null;
          if (packJson) {
            renderPackDetails(container, packJson);
          } else if (profileId) {
            supabaseClient
              .from('user_onboarding_pack_details')
              .select('pack_details')
              .eq('user_id', profileId)
              .single()
              .then(async ({ data, error }) => {
                if (!error && data?.pack_details) {
                  packJsonMap[profileId] = data.pack_details;
                  renderPackDetails(container, data.pack_details);
                  return;
                }

                if (!externalUserId) {
                  if (error) console.error('Pack details load error:', error);
                  renderPackDetails(container, null);
                  return;
                }

                try {
                  const applicantJson = await fetchApplicantByExternalId(externalUserId);
                  await persistPackForProfile(item, applicantJson);
                  renderPackDetails(container, applicantJson);
                } catch (fetchError) {
                  console.error('Pack details fetch error:', fetchError);
                  renderPackDetails(container, null);
                }
              });
          } else {
            renderPackDetails(container, null);
          }
          return;
        }

        if (view === 'holdings') {
          return;
        }
      }

      const sectionToggle = event.target.closest('.holdings-section-toggle');
      if (sectionToggle) {
        const section = sectionToggle.closest('.holdings-section');
        if (!section) return;
        const isCollapsed = section.classList.toggle('collapsed');
        sectionToggle.setAttribute('aria-expanded', String(!isCollapsed));
      }

      const toggle = event.target.closest('.timeline-details-toggle');
      if (toggle) {
        const details = toggle.nextElementSibling;
        if (!details) return;
        if (details.style.display === 'none') {
          details.style.display = 'block';
          toggle.textContent = 'Hide data ˄';
        } else {
          details.style.display = 'none';
          toggle.textContent = 'Show data ˅';
        }
      }

      const button = event.target.closest('.show-details-btn');
      if (button) {
        const item = button.closest('.simple-item');
        if (!item) return;
        const details = item.querySelector('.detailed-view');
        if (!details) return;
        const isNowOpen = details.classList.toggle('active');
        button.classList.toggle('is-open', isNowOpen);
        if (!isNowOpen) return;

        button.classList.add('is-loading');
        button.title = 'Refreshing profile...';
        button.setAttribute('aria-busy', 'true');
        button.disabled = true;
        refreshPackDataOnly(item)
          .catch((error) => {
            console.error('Pack refresh error:', error);
          })
          .finally(() => {
            button.classList.remove('is-loading');
            button.title = '';
            button.setAttribute('aria-busy', 'false');
            button.disabled = false;
          });
      }

      const phoneAdd = event.target.closest('.phone-add-btn');
      if (phoneAdd) {
        const item = phoneAdd.closest('.simple-item');
        if (!item) return;
        openPhoneModal(item);
      }

      const packDetailsBtn = event.target.closest('[data-pack-details]');
      if (packDetailsBtn) {
        const item = packDetailsBtn.closest('.simple-item');
        const container = packDetailsBtn.closest('.tabs-container');
        if (!item?.dataset?.profileId) return;
        const packJson = packJsonMap[item.dataset.profileId];
        renderPackDetails(container, packJson);
      }
    });

    if (phoneModalClose) phoneModalClose.addEventListener('click', closePhoneModal);
    if (phoneModalCancel) phoneModalCancel.addEventListener('click', closePhoneModal);
    if (phoneModal) {
      phoneModal.addEventListener('click', (event) => {
        if (event.target === phoneModal) closePhoneModal();
      });
    }

    if (imageModalClose) imageModalClose.addEventListener('click', closeImageModal);
    if (imageModal) {
      imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) closeImageModal();
      });
    }


    if (phoneModalSave) {
      phoneModalSave.addEventListener('click', async () => {
        const item = activePhoneItem;
        const profileId = item?.dataset?.profileId;
        const newNumber = phoneInput?.value?.trim();
        if (!item || !profileId || !newNumber) return;

        const { error } = await supabaseClient
          .from('profiles')
          .update({ phone_number: newNumber })
          .eq('id', profileId);

        if (error) {
          console.error('Phone update failed:', error);
          return;
        }

        const phoneEl = item.querySelector('[data-phone]');
        if (phoneEl) phoneEl.textContent = newNumber;
        closePhoneModal();
      });
    }

    const signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = '/signin.html';
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', applySearchFilter);
    }

    if (kycFilterPills.length) {
      kycFilterPills.forEach((pill) => {
        pill.addEventListener('click', () => {
          const value = pill.dataset.kycPill || 'all';
          activeProfileFilters.kyc = value;
          kycFilterPills.forEach((item) => item.classList.toggle('active', item === pill));
          applySearchFilter();
        });
      });
    }

    if (bankFilterBtn && bankFilterMenu) {
      bankFilterBtn.addEventListener('click', () => {
        const willOpen = !bankFilterMenu.classList.contains('active');
        bankFilterMenu.classList.toggle('active', willOpen);
        bankFilterBtn.setAttribute('aria-expanded', String(willOpen));
      });
    }

    if (bankFilterOptions.length) {
      bankFilterOptions.forEach((option) => {
        option.addEventListener('click', () => {
          const value = option.dataset.bankFilter || 'all';
          activeProfileFilters.bank = value;
          bankFilterOptions.forEach((item) => item.classList.toggle('active', item === option));
          if (bankFilterMenu) bankFilterMenu.classList.remove('active');
          if (bankFilterBtn) bankFilterBtn.setAttribute('aria-expanded', 'false');
          applySearchFilter();
        });
      });
    }

    document.addEventListener('click', (event) => {
      if (!bankFilterMenu || !bankFilterBtn) return;
      const withinMenu = bankFilterMenu.contains(event.target);
      const withinBtn = bankFilterBtn.contains(event.target);
      if (withinMenu || withinBtn) return;
      if (!bankFilterMenu.classList.contains('active')) return;
      bankFilterMenu.classList.remove('active');
      bankFilterBtn.setAttribute('aria-expanded', 'false');
    });

    requireSession().then((ok) => {
      if (ok) {
        loadProfiles();
      }
    });
  </script>
</body>
</html>
